ClipboardChanged(type) {
    Global SQLiteDB, DBPath, IsCopying, ClipboardLock, ProcessingContext, TransactionActive, TransactionOwner, G_last_insert_rowid, G_last_insert_Main_ID, G_last_insert_Main_TableName
	; üî• Ê∑ªÂä†Ëøô‰∏™Ê£ÄÊü• - ‰ªª‰ΩïÈùûÈõ∂ÁöÑ ClipboardLock ÈÉΩÂ∫îËØ•ÈòªÊ≠¢ÊâßË°å
    if (ClipboardLock != 0) {
        Return
    }
  
    WinGet, ActiveID, ID, A
    WinGetTitle, WindowTitle, ahk_id %ActiveID%
    if (InStr(WindowTitle, "Âç∞Ë±°ËÆ∞ÂøÜ_5")) {
        Return
    }
    if (type != 1 && type != 2) {
        Return
    }
    ClipboardLock := 3
    ProcessingContext := "Clipboard"
    FinalID := ""
    try {
        if (!CheckDBUnlocked(DBPath)) {
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4100220 ; Êï∞ÊçÆÂ∫ìË¢´ÈîÅÂÆöÔºÅ
            LoadData()
            Return
        }
        if (!SQLiteDB) {
            SQLiteDB := New SQLiteDB()
            if (!SQLiteDB.OpenDB(DBPath)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4103692 Êï∞ÊçÆÂ∫ìÊâìÂºÄÂ§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
        }
		
        ; Ê†πÊçÆÂâ™Ë¥¥ÊùøÂÜÖÂÆπÂä®ÊÄÅÂÜ≥ÂÆö‰∏ªË°®ÂêçÁß∞
        isFileSystemContent := false
        if (DllCall("IsClipboardFormatAvailable", "UInt", 15)) { ; CF_HDROP
            isFileSystemContent := true
        } else {
            TempClipData := Clipboard
            TempClipData := Trim(RegExReplace(TempClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", ""))
            if (TempClipData != "") {
                lines := StrSplit(TempClipData, "`n")
                FirstLine := Trim(lines[1])
                if (RegExMatch(FirstLine, "^[A-Za-z]:\\.*$") || RegExMatch(FirstLine, "^\\\\.*$")) {
                    isFileSystemContent := true
                }
            }
        }

        if (isFileSystemContent) {
            MainTable := "Database"
        } else {
            MainTable := "ÂéÜÂè≤Êï∞ÊçÆ"
        }
		
        OldMainTable := MainTable . "_temp_old"
        DataTable := "Data_" . MainTable
        OldDataTable := DataTable . "_temp_old"
        PropTable := MainTable . "_ÂÖ≥ËÅîÂ±ûÊÄß"
        OldPropTable := PropTable . "_temp_old"
        SQLiteDB.Exec("PRAGMA foreign_keys = OFF;")
        CheckMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . MainTable . "';"
        MainResult := {}
        if (SQLiteDB.GetTable(CheckMainSQL, MainResult) && MainResult.RowCount = 0) {
            CheckOldMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldMainTable . "';"
            OldMainResult := {}
            if (SQLiteDB.GetTable(CheckOldMainSQL, OldMainResult) && OldMainResult.RowCount > 0) {
                RenameMainSQL := "ALTER TABLE [" . OldMainTable . "] RENAME TO [" . MainTable . "];"
                if (SQLiteDB.Exec(RenameMainSQL)) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4111311 Êó†Ê≥ïÊÅ¢Â§ç‰∏ªË°®: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            } else {
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4113412 ‰∏ªË°®Áº∫Â§±‰∏îÊó†Â§á‰ªΩÔºÅ
                SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                LoadData()
                Return
            }
        } else {
            CheckOldMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldMainTable . "';"
            OldMainResult := {}
            if (SQLiteDB.GetTable(CheckOldMainSQL, OldMainResult) && OldMainResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldMainTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        CheckDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . DataTable . "';"
        DataResult := {}
        if (SQLiteDB.GetTable(CheckDataSQL, DataResult) && DataResult.RowCount = 0) {
            CheckOldDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldDataTable . "';"
            OldDataResult := {}
            if (SQLiteDB.GetTable(CheckOldDataSQL, OldDataResult) && OldDataResult.RowCount > 0) {
                RenameDataSQL := "ALTER TABLE [" . OldDataTable . "] RENAME TO [" . DataTable . "];"
                if (SQLiteDB.Exec(RenameDataSQL)) {
                    AlterDataSQL := "ALTER TABLE [" . DataTable . "] ADD FOREIGN KEY(lParentID) REFERENCES [" . MainTable . "](ID);"
                    SQLiteDB.Exec(AlterDataSQL)
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4119130 Êó†Ê≥ïÊÅ¢Â§çÊï∞ÊçÆË°®: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            }
        } else {
            CheckOldDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldDataTable . "';"
            OldDataResult := {}
            if (SQLiteDB.GetTable(CheckOldDataSQL, OldDataResult) && OldDataResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldDataTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        CheckPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTable . "';"
        PropResult := {}
        if (SQLiteDB.GetTable(CheckPropSQL, PropResult) && PropResult.RowCount = 0) {
            CheckOldPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldPropTable . "';"
            OldPropResult := {}
            if (SQLiteDB.GetTable(CheckOldPropSQL, OldPropResult) && OldPropResult.RowCount > 0) {
                RenamePropSQL := "ALTER TABLE [" . OldPropTable . "] RENAME TO [" . PropTable . "];"
                if (SQLiteDB.Exec(RenamePropSQL)) {
                    AlterPropFK1SQL := "ALTER TABLE [" . PropTable . "] ADD FOREIGN KEY(Â±ûÊÄßID) REFERENCES ÂÖ≥ËÅîÂ±ûÊÄßË°®(ID);"
                    AlterPropFK2SQL := "ALTER TABLE [" . PropTable . "] ADD FOREIGN KEY(ID) REFERENCES [" . MainTable . "](ID) ON DELETE CASCADE;"
                    SQLiteDB.Exec(AlterPropFK1SQL)
                    SQLiteDB.Exec(AlterPropFK2SQL)
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4127581 Êó†Ê≥ïÊÅ¢Â§çÂ±ûÊÄßË°®: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            }
        } else {
            CheckOldPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldPropTable . "';"
            OldPropResult := {}
            if (SQLiteDB.GetTable(CheckOldPropSQL, OldPropResult) && OldPropResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldPropTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='ÂÖ≥ËÅîÂ±ûÊÄßË°®';"
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTable . "';"
        CheckMainTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . MainTable . "';"
        AssocTableResult := {}
        PropTableResult := {}
        MainTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4133064 ÂÖ≥ËÅîÂ±ûÊÄßË°®‰∏çÂ≠òÂú®ÔºÅ
            LoadData()
            Return
        }
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4135569, A_Space . PropTable . " Ë°®‰∏çÂ≠òÂú®ÔºÅ"
            LoadData()
            Return
        }
        if (!SQLiteDB.GetTable(CheckMainTableSQL, MainTableResult) || MainTableResult.RowCount = 0) {
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4140580, A_Space . MainTable . " Ë°®‰∏çÂ≠òÂú®ÔºÅ"
            LoadData()
            Return
        }
        GetColumnsSQL := "PRAGMA table_info(" . MainTable . ");"
        ColumnsResult := {}
        RequiredFields := ["Â§áÊ≥®", "ÂÜÖÂÆπ", "ÁΩÆÈ°∂", "ÁΩÆÈ°∂Á¥¢Âºï", "Êî∂Ëóè", "Á¶ÅÂà†", "ÊòüÁ∫ß", "Ê†áÁ≠æ", "ÂàÜÁªÑ", "Á±ªÂûã", "ÂàõÂª∫Êó∂Èó¥", "‰øÆÊîπÊó∂Èó¥", "ËÆøÈóÆÊó∂Èó¥", "ËÆøÈóÆÊ¨°Êï∞", "Êõ¥Êñ∞Ê¨°Êï∞", "Â≠óËäÇ", "Â≠óÁ¨¶", "Ë°åÊï∞", "Êï∞Èáè", "Ê†áËØÜ", "Á™óÂè£ËØ¶ÊÉÖ", "Â∫îÁî®ÂêçÁß∞", "ÂìàÂ∏åÂÄº", "ÊéíÂ∫è", "Ê†áËÆ∞Áä∂ÊÄÅ"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4146625, A_Space . MainTable . "Ë°®Áº∫Â∞ëÂøÖË¶ÅÂ≠óÊÆµÔºö%MissingFieldsList%"
                LoadData()
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4149159 Êü•ËØ¢Ë°®ÁªìÊûÑÂ§±Ë¥•: %ErrorMsg%
            LoadData()
            Return
        }
        Sleep, 100
        ClipData := ""
        Format := ""
        DataType := 1
        Identifier := ""
        FileCount := 0
        ValidCount := 0
        TotalSize := 0
        Bytes := ""
        Group := ""
        Remark := ""
        AllPaths := []
        FolderPath := ""
        if (!BeginSafeTransaction("ClipboardChanged")) {
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö1938940 ÂºÄÂßã‰∫ãÂä°Â§±Ë¥•ÔºÅ
            LoadData()
            Return
        }
        if (DllCall("IsClipboardFormatAvailable", "UInt", 15)) {
            Format := "CF_HDROP"
            ClipData := Clipboard
            FilePathsList := ""
          
            Loop, Parse, Clipboard, `n, `r
            {
                Path := Trim(A_LoopField)
                if (Path != "" && FileExist(Path)) {
                    AllPaths.Push(Path)
                    FileCount++
                }
            }
          
            if (FileCount = 0) {
                RollbackSafeTransaction("ClipboardChanged")
                LoadData()
                Return
            }
          
            Path := AllPaths[1]
            FileAttrib := FileExist(Path)
            isFolderMode := InStr(FileAttrib, "D")
          
            SplitPath, Path, FileName, FileDir, FileExt, FileNameNoExt
            SplitPath, FileDir, , , , ParentDir
            Group := FileDir ? ParentDir : ""
          
            if (isFolderMode) {
                Loop, % AllPaths.MaxIndex() {
                    CurrentPath := AllPaths[A_Index]
                    CurrentAttrib := FileExist(CurrentPath)
                    if (!InStr(CurrentAttrib, "D")) {
                        continue
                    }
                  
                    ; üî• Êî∂ÈõÜÂΩìÂâçÊñá‰ª∂Â§πÁöÑÁ¨¨‰∏ÄÂ±ÇÂ≠êÊñá‰ª∂Â§πÂíåÊñá‰ª∂
                    FirstLevelFolders := []
                    FirstLevelFiles := []
                    
                    ; ÂÖàÊî∂ÈõÜÂ≠êÊñá‰ª∂Â§π
                    Loop, Files, %CurrentPath%\*.*, D
                    {
                        FirstLevelFolders.Push(A_LoopFileFullPath)
                    }
                    
                    ; ÂÜçÊî∂ÈõÜÁõ¥Êé•Êñá‰ª∂
                    Loop, Files, %CurrentPath%\*.*, F
                    {
                        FirstLevelFiles.Push(A_LoopFileFullPath)
                    }
                    
                    ; üî• ‰∏∫ÊØè‰∏™Â≠êÊñá‰ª∂Â§πÂçïÁã¨ÂàõÂª∫ËÆ∞ÂΩï
                    Loop, % FirstLevelFolders.Length() {
                        SubFolderPath := FirstLevelFolders[A_Index]
                        
                        LocalValidCount := 0
                        LocalTotalSize := 0
                        LocalFilePathsList := ""
                        
                        ; Êî∂ÈõÜÂ≠êÊñá‰ª∂Â§πÁöÑÁ¨¨‰∏ÄÂ±ÇÂÜÖÂÆπ
                        Loop, Files, %SubFolderPath%\*.*, D
                        {
                            LocalFilePathsList .= A_LoopFileFullPath . "`n"
                            LocalValidCount++
                            
                            ; ÈÄíÂΩíËÆ°ÁÆóÂ§ßÂ∞è
                            Loop, Files, %A_LoopFileFullPath%\*.*, FR
                            {
                                FileGetSize, FileSize, %A_LoopFileFullPath%, B
                                LocalTotalSize += FileSize
                            }
                        }
                        
                        Loop, Files, %SubFolderPath%\*.*, F
                        {
                            LocalFilePathsList .= A_LoopFileFullPath . "`n"
                            LocalValidCount++
                            FileGetSize, FileSize, %A_LoopFileFullPath%, B
                            LocalTotalSize += FileSize
                        }
                        
                        LocalFilePathsList := RTrim(LocalFilePathsList, "`n")
                        LocalClipData := LocalFilePathsList
                      
                        LocalSizeStr := FormatBytes(LocalTotalSize)
                      
                        SplitPath, SubFolderPath, LocalFileName, LocalFileDir, , LocalFileNameNoExt
                        SplitPath, LocalFileDir, , , , LocalParentDir
                        LocalGroup := LocalFileDir ? LocalParentDir : ""
                      
                        LocalTempRemark := "Copied Folder - " . LocalFileNameNoExt . " | Êï∞Èáè: 1 | ÊúâÊïà: " . LocalValidCount . " | Â§ßÂ∞è: " . LocalSizeStr
                        LocalContent := LocalTempRemark
                        LocalRemark := SubFolderPath
                      
                        LocalIdentifier := "üìÅ"
                        LocalFormat := "CF_HDROP,üìÅ"
                      
                        ClipData := LocalClipData
                        Content := LocalContent
                        Remark := LocalRemark
                        Identifier := LocalIdentifier
                        Format := LocalFormat
                        Group := LocalGroup
                      
                        gosub, InsertCommon
                        if (FinalID = "" || FinalID <= 0) {
                            return
                        }
                    }
                    
                    ; üî• Â¶ÇÊûúÁà∂Êñá‰ª∂Â§πÊúâÁõ¥Êé•Êñá‰ª∂Ôºå‰∏∫Ëøô‰∫õÊñá‰ª∂ÂàõÂª∫‰∏ÄÊù°ËÆ∞ÂΩï
                    if (FirstLevelFiles.Length() > 0) {
                        LocalValidCount := FirstLevelFiles.Length()
                        LocalTotalSize := 0
                        LocalFilePathsList := ""
                        
                        Loop, % FirstLevelFiles.Length() {
                            FilePath := FirstLevelFiles[A_Index]
                            LocalFilePathsList .= FilePath . "`n"
                            FileGetSize, FileSize, %FilePath%, B
                            LocalTotalSize += FileSize
                        }
                        
                        LocalFilePathsList := RTrim(LocalFilePathsList, "`n")
                        LocalClipData := LocalFilePathsList
                      
                        LocalSizeStr := FormatBytes(LocalTotalSize)
                      
                        SplitPath, CurrentPath, LocalFileName, LocalFileDir, , LocalFileNameNoExt
                        SplitPath, LocalFileDir, , , , LocalParentDir
                        LocalGroup := LocalFileDir ? LocalParentDir : ""
                      
                        LocalTempRemark := "Copied Files from - " . LocalFileNameNoExt . " | Êï∞Èáè: " . LocalValidCount . " | ÊúâÊïà: " . LocalValidCount . " | Â§ßÂ∞è: " . LocalSizeStr
                        LocalContent := LocalTempRemark
                        LocalRemark := CurrentPath
                      
                        LocalIdentifier := "üìÅ"
                        LocalFormat := "CF_HDROP,üìÅ"
                      
                        ClipData := LocalClipData
                        Content := LocalContent
                        Remark := LocalRemark
                        Identifier := LocalIdentifier
                        Format := LocalFormat
                        Group := LocalGroup
                      
                        gosub, InsertCommon
                        if (FinalID = "" || FinalID <= 0) {
                            return
                        }
                    }
                }
            } else {
                ValidCount := 0
                TotalSize := 0
                FilePathsList := ""
                Loop, % AllPaths.MaxIndex() {
                    CurrentPath := AllPaths[A_Index]
                    FilePathsList .= CurrentPath . "`n"
                    FileGetSize, FileSize, %CurrentPath%, B
                    TotalSize += FileSize
                    ValidCount++
                }
                FilePathsList := RTrim(FilePathsList, "`n")
                ClipData := FilePathsList
              
                SizeStr := FormatBytes(TotalSize)
              
                ; ‰ΩøÁî® GetFileTypeSymbol ÂáΩÊï∞Ëé∑ÂèñÊ†áËØÜÁ¨¶
                Identifier := GetFileTypeSymbol(Path, FileExt)
                Format := "CF_HDROP," . Identifier
                if (FileExt != "") {
                    Format .= "," . FileExt
                }
                TempRemark := "Copied File - " . FileNameNoExt . " | Êï∞Èáè: " . FileCount . " | ÊúâÊïà: " . ValidCount . " | Â§ßÂ∞è: " . SizeStr
                Content := TempRemark
                Remark := FileName
              
                gosub, InsertCommon
                if (FinalID = "" || FinalID <= 0) {
                    return
                }
            }
        } else {
            ClipData := Clipboard
            Format := "CF_UNICODETEXT"
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || RegExMatch(ClipData, "^\s*$")) {
                RollbackSafeTransaction("ClipboardChanged")
                LoadData()
                Return
            }
            if (StrLen(ClipData) > 5000000) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4159040 ÊñáÊú¨Ââ™Ë¥¥ÊùøÂÜÖÂÆπËøáÂ§ßÔºàË∂ÖËøá 5MBÔºâÔºÅ
                LoadData()
                Return
            }
            lines := StrSplit(ClipData, "`n")
            FirstLine := Trim(lines[1])
            if (RegExMatch(FirstLine, "^[A-Za-z]:\\.*$") || RegExMatch(FirstLine, "^\\\\.*$")) {
                FirstAttrib := FileExist(FirstLine)
                SplitPath, FirstLine, FileName, FileDir, FileExt, FileNameNoExt
                if (InStr(FirstAttrib, "D")) {
                    Identifier := "üìÅùìü"
                    Format := "CF_UNICODETEXT,üìÅùìü"
                } else {
                    ; ‰ΩøÁî® GetFileTypeSymbol ÂáΩÊï∞Ëé∑ÂèñÊ†áËØÜÁ¨¶
                    Identifier := GetFileTypeSymbol(FirstLine, FileExt) . "ùìü"
                    Format := "CF_UNICODETEXT," . Identifier
                    if (FileExt != "") {
                        Format .= "," . FileExt
                    }
                }
                FileCount := 0
                ValidCount := 0
                TotalSize := 0
                Loop, % lines.Length() {
                    Path := Trim(lines[A_Index])
                    if (Path != "" && FileExist(Path)) {
                        FileAttrib := FileExist(Path)
                        FileCount++
                        if (InStr(FileAttrib, "D")) {
                            Loop, Files, %Path%\*.*, F
                            {
                                if (FileExist(A_LoopFileFullPath)) {
                                    ValidCount++
                                    FileGetSize, FileSize, %A_LoopFileFullPath%, B
                                    TotalSize += FileSize
                                }
                            }
                        } else {
                            ValidCount++
                            FileGetSize, FileSize, %Path%, B
                            TotalSize += FileSize
                        }
                    }
                }
                SizeStr := FormatBytes(TotalSize)
                SplitPath, FileDir, , , , ParentDir
                Group := FileDir ? ParentDir : ""
                if (InStr(FirstAttrib, "D")) {
                    TempRemark := "Copied Folder Path - " . FileNameNoExt . " | Êï∞Èáè: " . FileCount . " | ÊúâÊïà: " . ValidCount . " | Â§ßÂ∞è: " . SizeStr
                } else {
                    TempRemark := "Copied File Path - " . FileNameNoExt . " | Êï∞Èáè: " . FileCount . " | ÊúâÊïà: " . ValidCount . " | Â§ßÂ∞è: " . SizeStr
                }
                Content := RegExReplace(ClipData, "[\r\n]+", " ")
                Remark := Content
                Content := TempRemark
            } else {
                if (RegExMatch(ClipData, "^(https?|ftp)://[A-Za-z0-9\-\.]+(:[0-9]+)?(/[A-Za-z0-9\-\._~:/?#\[\]@!$&'()*+,;=%]*)?$")) {
                    Format := "CF_UNICODETEXT,üîó"
                    Identifier := "üîó"
                    Content := ClipData
                    if (RegExMatch(ClipData, "://([^/]+)", domainMatch)) {
                        fullDomain := domainMatch1
                        if (RegExMatch(fullDomain, "^(?:www\.)?([^.]+)\.[^.]+$", mainDomainMatch)) {
                            Remark := mainDomainMatch1
                        } else {
                            Remark := fullDomain
                        }
                    } else {
                        Remark := SubStr(ClipData, 1, 200)
                    }
                } else {
                    Remark := FirstLine
                    ByteCount := StrPut(ClipData, "UTF-8") - 1
                    Bytes := FormatBytes(ByteCount)
                    CharCount := StrLen(ClipData)
                    LineCount := lines.Length()
                    Content := "[ÊñáÊú¨] | " . CharCount . " Â≠óÁ¨¶ | " . Bytes . " | " . LineCount . " Ë°å"
                }
            }
          
            gosub, InsertCommon
            if (FinalID = "" || FinalID <= 0) {
                return
            }
        }
        ; === ÂàÜÁ±ªÂ≠óÂÖ∏_OneÔºöÊúÄÂêéÊèíÂÖ•IDÔºàÁªü‰∏ÄÁªìÊûÑÔºâ===
        DeleteRecordSQL := "DELETE FROM ""ÂàÜÁ±ªÂ≠óÂÖ∏_One"" WHERE ""Category_Main"" = 'ÊúÄÂêéÊèíÂÖ•ID' AND ""Category_Sub"" = 'ÊúÄÂêéÊèíÂÖ•ID';"
        SQLiteDB.Exec(DeleteRecordSQL)
        LastIDValue := (FinalID ? FinalID : "")
        InsertRecordSQL := "INSERT OR REPLACE INTO ""ÂàÜÁ±ªÂ≠óÂÖ∏_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('ÊúÄÂêéÊèíÂÖ•ID', 'ÊúÄÂêéÊèíÂÖ•ID', ?, 1, datetime('now','localtime'));"
        if (SQLiteDB.ExecuteWithParams) {
            SQLiteDB.ExecuteWithParams(InsertRecordSQL, [LastIDValue])
        } else {
            EscapedLastID := StrReplace(LastIDValue, "'", "''")
            FallbackSQL := "INSERT OR REPLACE INTO ""ÂàÜÁ±ªÂ≠óÂÖ∏_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('ÊúÄÂêéÊèíÂÖ•ID', 'ÊúÄÂêéÊèíÂÖ•ID', '" . EscapedLastID . "', 1, datetime('now','localtime'));"
            SQLiteDB.Exec(FallbackSQL)
        }
        if (!CommitSafeTransaction("ClipboardChanged")) {
            RollbackSafeTransaction("ClipboardChanged")
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö3828190 ‰∫ãÂä°Êèê‰∫§Â§±Ë¥•ÔºÅ
            LoadData()
            Return
        }
        AttrCount := VerifyAllAttributes(FinalID, MainTable)
        if (AttrCount < 0) {
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö5020111 Â±ûÊÄßÂÖ≥ËÅîÈ™åËØÅÂ§±Ë¥•
        }
        return
    InsertCommon:
        HashValue := ""
        try {
            if (ClipData != "") {
                HashValue := Crypt.Hash.Str(ClipData, "SHA256")
            }
        } catch e {
            eMessage := e.Message
            RollbackSafeTransaction("ClipboardChanged")
            MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö5334156 ËÆ°ÁÆóÂìàÂ∏åÂÄºÂ§±Ë¥•: %eMessage%
            LoadData()
            Return
        }
        ; === ‰ΩøÁî®ÂàÜÁ±ªÂ≠óÂÖ∏_OneË°®Áª¥Êä§ÊéíÂ∫èÊúÄÂ§ßÂÄºÔºàÂ∏¶ÂîØ‰∏ÄÊÄßÂ§ÑÁêÜÔºâ===
        GetMaxSortSQL := "SELECT COALESCE(""Record_Value"", 0) FROM ""ÂàÜÁ±ªÂ≠óÂÖ∏_One"" WHERE ""Category_Main"" = 'ÊéíÂ∫èÂÄº' AND ""Category_Sub"" = 'ÊúÄÂ§ßÂÄº' LIMIT 1;"
        MaxSortResult := {}
        CurrentMax := 0
        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
            CurrentMax := MaxSortResult.Rows[1][1] + 0 ; Âº∫Âà∂ËΩ¨‰∏∫Êï∞Â≠ó
        } else {
            ; ÂàùÂßãÂåñ
            InitSQL := "INSERT OR IGNORE INTO ""ÂàÜÁ±ªÂ≠óÂÖ∏_One"" (""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                     . "VALUES ('ÊéíÂ∫èÂÄº', 'ÊúÄÂ§ßÂÄº', '0', 0, datetime('now','localtime'));"
            if (!SQLiteDB.Exec(InitSQL)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö3646934 Êñ∞ID-ÊéíÂ∫èÂàùÂßãÂåñÂ§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
            CurrentMax := 0
        }
        ; Âæ™ÁéØËé∑ÂèñÂîØ‰∏ÄÊéíÂ∫èÂÄº
        Loop {
            NewSortValue := CurrentMax + 1
            ; Â∞ùËØïÊõ¥Êñ∞ÊúÄÂ§ßÂÄº
            UpdateMaxSQL := "UPDATE ""ÂàÜÁ±ªÂ≠óÂÖ∏_One"" SET ""Record_Value"" = ?, ""Update_Time"" = datetime('now','localtime') "
                          . "WHERE ""Category_Main"" = 'ÊéíÂ∫èÂÄº' AND ""Category_Sub"" = 'ÊúÄÂ§ßÂÄº' AND ""Record_Value"" = ?;"
            Success := false
            RetryCount := 3
            while (RetryCount > 0) {
                if (SQLiteDB.ExecuteWithParams) {
                    if (SQLiteDB.ExecuteWithParams(UpdateMaxSQL, [NewSortValue, CurrentMax])) {
                        Success := true
                        break
                    }
                } else {
                    FallbackSQL := "UPDATE ""ÂàÜÁ±ªÂ≠óÂÖ∏_One"" SET ""Record_Value"" = '" . NewSortValue . "', ""Update_Time"" = datetime('now','localtime') "
                                 . "WHERE ""Category_Main"" = 'ÊéíÂ∫èÂÄº' AND ""Category_Sub"" = 'ÊúÄÂ§ßÂÄº' AND ""Record_Value"" = '" . CurrentMax . "';"
                    if (SQLiteDB.Exec(FallbackSQL)) {
                        Success := true
                        break
                    }
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 50
                    RetryCount--
                    continue
                }
                ; Êñ∞Â¢ûÔºöÊ£ÄÊü•ÂîØ‰∏ÄÁ∫¶ÊùüÂ§±Ë¥•
                if (InStr(ErrorMsg, "UNIQUE constraint failed")) {
                    ; ÈáçÊñ∞ËØªÂèñÔºà‰ΩøÁî®‰øÆÂ§çÂêéÁöÑ SQLÔºâ
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                    break ; ÈÄÄÂá∫ whileÔºåÈáçËØïÂ§ñÂ±Ç Loop
                }
                break
            }
            if (Success) {
                ; Êõ¥Êñ∞ÊàêÂäüÔºåËØ¥Êòé NewSortValue ÂèØÁî®
                break
            } else {
                ; Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ¥ÊòéÊúâÂπ∂ÂèëÔºåÈáçÊñ∞ËØªÂèñÂΩìÂâçÊúÄÂ§ßÂÄº
                if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                    CurrentMax := MaxSortResult.Rows[1][1] + 0
                } else {
                    CurrentMax := 0
                }
            }
        }
        ExistingID := ""
        CheckSQL := "SELECT ID FROM " . MainTable . " WHERE ÂìàÂ∏åÂÄº = ? LIMIT 1;"
        CheckResult := {}
        if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
            ExistingID := CheckResult.Rows[1][1]
        }
        if (StrLen(Content) > 1000000) {
            Content := SubStr(Content, 1, 1000000)
        }
        if (StrLen(Remark) > 1000) {
            Remark := SubStr(Remark, 1, 1000)
        }
        HashValue := HashValue ? HashValue : ""
        Bytes := Bytes ? Bytes : ""
        WindowDetail := WindowTitle ? WindowTitle : ""
        Identifier := Identifier ? Identifier : ""
        Format := Format ? Format : ""
        Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        Content := Content ?RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "Êú™Áü•Â∫îÁî®"
        if (RegExMatch(WindowTitle, "(.+)\s*-\s*(.+)$", Match)) {
            AppName := Trim(Match2)
        } else {
            AppName := WindowTitle ? WindowTitle : "Êú™Áü•Â∫îÁî®"
        }
        EscapedHashValue := StrReplace(HashValue, "'", "''")
        EscapedBytes := StrReplace(Bytes, "'", "''")
        EscapedWindowDetail := StrReplace(WindowTitle, "'", "''")
        EscapedIdentifier := StrReplace(Identifier, "'", "''")
        EscapedFormat := StrReplace(Format, "'", "''")
        EscapedRemark := StrReplace(Remark, "'", "''")
        EscapedContent := StrReplace(Content, "'", "''")
        EscapedGroup := StrReplace(Group, "'", "''")
        EscapedAppName := StrReplace(AppName, "'", "''")
        EscapedClipData := StrReplace(ClipData, "'", "''")
        Success := false
        RetryCount := 3
        G_last_insert_rowid := ""
      
        if (ExistingID != "") {
            ; üî• ‰øÆÊîπÔºöUPDATE ËØ≠Âè•‰∏≠ Á±ªÂûã„ÄÅÂàÜÁªÑ„ÄÅÂ∫îÁî®ÂêçÁß∞„ÄÅÊ†áËØÜ ËÆæ‰∏∫Á©∫
            UpdateSQL := "UPDATE " . MainTable . " SET ÊéíÂ∫è = " . NewSortValue . ", Êõ¥Êñ∞Ê¨°Êï∞ = COALESCE(Êõ¥Êñ∞Ê¨°Êï∞, 0) + 1, ‰øÆÊîπÊó∂Èó¥ = datetime('now', 'localtime'), ËÆøÈóÆÊó∂Èó¥ = datetime('now', 'localtime'), ÂÜÖÂÆπ = '" . EscapedContent . "', Â≠óËäÇ = '" . EscapedBytes . "', Á™óÂè£ËØ¶ÊÉÖ = '" . EscapedWindowDetail . "', Á±ªÂûã = '', ÂàÜÁªÑ = '', Â∫îÁî®ÂêçÁß∞ = '', Ê†áËØÜ = '', Â§ÑÁêÜÁä∂ÊÄÅ = NULL, ÊèêÁ§∫Êó∂Èó¥ = NULL, ÊèêÁ§∫ = NULL WHERE ID = " . ExistingID . ";"
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(UpdateSQL)) {
                    Success := true
                    FinalID := ExistingID
                    G_last_insert_rowid := ExistingID
                    G_last_insert_Main_ID := ExistingID
                    G_last_insert_Main_TableName := MainTable
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö3720054 Êõ¥Êñ∞‰∏ªË°®Â§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
            DeleteDataSQL := "DELETE FROM " . DataTable . " WHERE lParentID = " . ExistingID . ";"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(DeleteDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö3724787 ; Âà†Èô§Êï∞ÊçÆË°®Â§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
            InsertDataSQL := "INSERT INTO " . DataTable . " (lParentID, strClipBoardFormat, ooData) VALUES (" . ExistingID . ", '" . EscapedFormat . "', '" . EscapedClipData . "');"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö3958064 ; ÊèíÂÖ•Êï∞ÊçÆË°®Â§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
        } else {
            AllocSQL := "INSERT INTO ‰∏≠ÂøÉÂåñ (Ê†áËÆ∞Áä∂ÊÄÅ) VALUES (0);"
            if (!SQLiteDB.Exec(AllocSQL)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö5142862 ; ÂàÜÈÖçÂÖ®Â±ÄIDÂ§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
          
            LastIDResult := {}
            G_last_insert_rowid := ""
            FinalID := ""
            if (SQLiteDB.GetTable("SELECT last_insert_rowid() AS newid;", LastIDResult) && LastIDResult.RowCount > 0) {
                G_last_insert_rowid := LastIDResult.Rows[1][1]
                FinalID := G_last_insert_rowid
            } else {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö5224280 ;  Ëé∑ÂèñÂÖ®Â±ÄIDÂ§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
          
            if (FinalID = "" || FinalID <= 0) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö5234045 ;  ÂÖ®Â±ÄIDÊó†Êïà: FinalID = %FinalID%
                LoadData()
                Return
            }
          
            ; üî• ‰øÆÊîπÔºöINSERT ËØ≠Âè•‰∏≠ Á±ªÂûã„ÄÅÂàÜÁªÑ„ÄÅÂ∫îÁî®ÂêçÁß∞„ÄÅÊ†áËØÜ ËÆæ‰∏∫Á©∫Â≠óÁ¨¶‰∏≤
            InsertMainSQL := "INSERT INTO " . MainTable . " (ID, ÂìàÂ∏åÂÄº, Â≠óËäÇ, Á™óÂè£ËØ¶ÊÉÖ, Á±ªÂûã, ÊéíÂ∫è, Êõ¥Êñ∞Ê¨°Êï∞, ÂàõÂª∫Êó∂Èó¥, ‰øÆÊîπÊó∂Èó¥, ËÆøÈóÆÊó∂Èó¥, Â§áÊ≥®, ÂÜÖÂÆπ, ÂàÜÁªÑ, Â∫îÁî®ÂêçÁß∞, Ê†áËØÜ, Â§ÑÁêÜÁä∂ÊÄÅ, ÊèêÁ§∫Êó∂Èó¥, ÊèêÁ§∫) VALUES (" . FinalID . ", '" . EscapedHashValue . "', '" . EscapedBytes . "', '" . EscapedWindowDetail . "', '', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '', '', '', NULL, NULL, NULL);"
          
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertMainSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "UNIQUE constraint failed: " . MainTable . ".ÊéíÂ∫è")) {
                    ; ÊéíÂ∫èÂÄºÂÜ≤Á™ÅÔºåÈáçÊñ∞Ëé∑Âèñ
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                    NewSortValue := CurrentMax + 1
                    InsertMainSQL := RegExReplace(InsertMainSQL, "ÊéíÂ∫è = \d+", "ÊéíÂ∫è = " . NewSortValue)
                    Sleep, 50
                    RetryCount--
                    continue
                }
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                ; MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö1333744 ÊèíÂÖ•‰∏ªË°®Â§±Ë¥•: %ErrorMsg%`n`nSQL: %InsertMainSQL%
				GetGlobalMaxSortValue()
				ClipboardChanged(type)
                ; LoadData()
                Return
            }
          
            MarkSQL := "UPDATE ‰∏≠ÂøÉÂåñ SET Ê†áËÆ∞Áä∂ÊÄÅ = 1 WHERE Local_ID = " . FinalID . ";"
            if (!SQLiteDB.Exec(MarkSQL)) {
            }
          
            InsertDataSQL := "INSERT INTO " . DataTable . " (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", '" . EscapedFormat . "', '" . EscapedClipData . "');"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4653894 ÊèíÂÖ•Êï∞ÊçÆË°®Â§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
            G_last_insert_Main_ID := FinalID
            G_last_insert_Main_TableName := MainTable
        }
        
        ; üî• Â±ûÊÄßÊèíÂÖ•ÈÉ®ÂàÜ - ÂºÄÂßãÔºàÂ∞Ü Á±ªÂûã„ÄÅÂàÜÁªÑ„ÄÅÂ∫îÁî®ÂêçÁß∞„ÄÅÊ†áËØÜ ÊèíÂÖ•Âà∞ÂÖ≥ËÅîÂ±ûÊÄßË°®Ôºâ
        Attributes := []
        Attributes.Push({Format: "ÊòüÁ∫ß", Value: "0"})
        
        ; Â∞ÜÁ±ªÂûãÂ≠óÊÆµÊãÜÂàÜÂêéÊèíÂÖ•Âà∞ÂÖ≥ËÅîÂ±ûÊÄßË°®
        if (Format != "") {
            ; ÊãÜÂàÜÊ†ºÂºèÂ≠óÁ¨¶‰∏≤ÔºàÂ¶Ç "CF_HDROP,üìé,exe" -> ["CF_HDROP", "üìé", "exe"]Ôºâ
            FormatParts := StrSplit(Format, ",")
            Loop, % FormatParts.Length() {
                TypeValue := Trim(FormatParts[A_Index])
                if (TypeValue != "" && TypeValue != "CF_HDROP" && TypeValue != "CF_UNICODETEXT") {
                    ; ËøáÊª§ÊéâÁ≥ªÁªüÊ†ºÂºèÊ†áËØÜÔºåÂè™‰øùÁïôÊúâÊÑè‰πâÁöÑÁ±ªÂûã
                    Attributes.Push({Format: "Á±ªÂûã", Value: TypeValue})
                }
            }
        }
        
        ; Â∞ÜÊ†áËØÜÁ¨¶‰πüÊèíÂÖ•Âà∞ÂÖ≥ËÅîÂ±ûÊÄßË°®
        if (Identifier != "") {
            Attributes.Push({Format: "Ê†áËØÜ", Value: Identifier})
        }
        
        ; Â¶ÇÊûúÊòØÁΩëÂùÄÔºåÊ∑ªÂä†ÁâπÂÆöÂÖ≥ÈîÆÂ≠ó
        if (Identifier = "üîó") {
            Attributes.Push({Format: "ÂÖ≥ÈîÆÂ≠ó", Value: "ÁΩëÂùÄ"})
            Attributes.Push({Format: "ÂÖ≥ÈîÆÂ≠ó", Value: "ÈìæÊé•"})
            Attributes.Push({Format: "ÂÖ≥ÈîÆÂ≠ó", Value: "ÁΩëÁ´ô"})
        }
        
        if (DataType = 1 && ClipData != "") {
            if (InStr(ClipData, ";") || InStr(ClipData, "{") || InStr(ClipData, "}") || InStr(ClipData, "function") || InStr(ClipData, "def ") || InStr(ClipData, "#include") || InStr(ClipData, "public ") || InStr(ClipData, "private ") || InStr(ClipData, "class ") || InStr(ClipData, "var ") || InStr(ClipData, "let ") || InStr(ClipData, "const ") || InStr(ClipData, "if (") || InStr(ClipData, "else") || InStr(ClipData, "for (") || InStr(ClipData, "while (")) {
                Attributes.Push({Format: "ÂÖ≥ÈîÆÂ≠ó", Value: "‰ª£Á†Å"})
            }
        }
        
        ; Â∞ÜÂàÜÁªÑÊèíÂÖ•Âà∞ÂÖ≥ËÅîÂ±ûÊÄßË°®
        if (Group != "") {
            Attributes.Push({Format: "ÂàÜÁªÑ", Value: Group})
        }
        
        ; Â∞ÜÂ∫îÁî®ÂêçÁß∞ÊèíÂÖ•Âà∞ÂÖ≥ËÅîÂ±ûÊÄßË°®
        if (AppName != "" && AppName != "Êú™Áü•Â∫îÁî®") {
            Attributes.Push({Format: "Â∫îÁî®ÂêçÁß∞", Value: AppName})
            IsFolderPath := (RegExMatch(AppName, "^[A-Za-z]:\\.*$") && InStr(FileExist(AppName), "D"))
            if (!IsFolderPath) {
                Tags := []
                if (RegExMatch(AppName, "^(.+)\s*-\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    if (!RegExMatch(FirstPart, "\.[a-zA-Z0-9]{1,4}$")) {
                        Tags.Push(FirstPart)
                    }
                    if (SecondPart = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(SecondPart)
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(AppName)
                    }
                }
                for index, Tag in Tags {
                    if (Tag != "" && Tag != "Êú™Áü•Â∫îÁî®") {
                        Attributes.Push({Format: "ÂÖ≥ÈîÆÂ≠ó", Value: Tag})
                    }
                }
            }
        }
        
        for index, attr in Attributes {
            Result := InsertAttribute(MainTable, FinalID, attr.Format, attr.Value)
            ErrorMsg := Result.ErrorMsg
            if (!Result.Success && ErrorMsg != "ÊòüÁ∫ß‰∏∫ 0ÔºåË∑≥ËøáÊèíÂÖ•" && ErrorMsg != "Â±ûÊÄßÊ†ºÂºèÊàñÂÄº‰∏∫Á©∫ÔºåË∑≥Ëøá") {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö2125567 ÊèíÂÖ•Â±ûÊÄßÂ§±Ë¥•: %ErrorMsg%
                LoadData()
                Return
            }
        }
        ; üî• Â±ûÊÄßÊèíÂÖ•ÈÉ®ÂàÜ - ÁªìÊùü
        
        return
      
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("ClipboardChanged")
        MsgBox, 16, ÈîôËØØ, ÈîôËØØ IDÔºö4846379 ClipboardChanged ÂºÇÂ∏∏: %eMessage%
    } finally {
        G_last_insert_rowid := FinalID
        g_CurrentRecord.ID := FinalID
        g_CurrentRecord.TableName := MainTable
        SB_SetText("ClipboardChanged: Â°´ÂÖÖÁºìÂ≠ò ID=" . FinalID)
        ProcessingContext := ""
        if (ClipboardLock = 3) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
		
		SyncDatabaseWithFileSystem()
        LoadData()
		GetGlobalMaxSortValue()
		
    }
    Return
}

CheckExt(extList, fileExt) {
    for _, ext in extList
        if (ext = fileExt)
            return true
    return false
}

GetFileTypeSymbol(filePath, fileExt) {
    if (InStr(FileExist(filePath), "D")) {
        return "üìÅ"
    }

    ; ÂàÜÁ±ªÊï∞ÁªÑÔºå‰∏•Ê†ºÊåâÊâ©Â±ïÂêçÂåπÈÖç
    lossyMusicExts := ["mp3","aac","m4a","ogg"]
    losslessMusicExts := ["flac","alac","ape"]
    uncompressedMusicExts := ["wav","aiff"]
    specialMusicExts := ["dsf","dff","mid"]
    videoExts := ["mp4","avi","mkv","wmv","flv","mov"]
    imageExts := ["jpg","jpeg","png","gif","bmp","tiff","psd","ai","svg","eps","cdr","heic","webp","avif","ico","raw","nef","cr2","arw","tga","dds"]
    docExts := ["doc","docx","pdf","txt","rtf"]

    ; Áªü‰∏ÄËΩ¨Â∞èÂÜôÔºåÈÅøÂÖçÂ§ßÂ∞èÂÜôËØØÂà§
    fileExt := StrLower(fileExt)

    ; ÂàÜÁ±ªÂà§Êñ≠
    if (CheckExt(lossyMusicExts, fileExt))
        return "üéß,‚ô´"
    else if (CheckExt(losslessMusicExts, fileExt) || (fileExt = "m4a" && InStr(filePath, "ALAC")))
        return "üéº,‚ô´"
    else if (CheckExt(uncompressedMusicExts, fileExt))
        return "üìÄ,‚ô´"
    else if (CheckExt(specialMusicExts, fileExt))
        return "üé∂,‚ô´"
    else if (CheckExt(videoExts, fileExt))
        return "üé•"
    else if (CheckExt(imageExts, fileExt))
        return "üñºÔ∏è"
    else if (CheckExt(docExts, fileExt))
        return "üìé"
    else
        return "üìé"
}

InsertAttribute(TableName, DataID, AttrFormat, AttrValue, DataFormat := "") {
    Global SQLiteDB, DBPath
    Result := {}
    Result.Success := 0
    Result.ErrorMsg := ""
    Result.AttrID := ""

    ; AddDebugLog("InsertAttribute ÂºÄÂßã, TableName=" . TableName . ", DataID=" . DataID . ", AttrFormat=" . AttrFormat . ", AttrValue=" . AttrValue . ", DataFormat=" . DataFormat)

    if (!SQLiteDB) {
        Result.ErrorMsg := "ERROR_202547: SQLiteDB Êú™ÂàùÂßãÂåñ"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    if (!CheckDBUnlocked(DBPath)) {
        Result.ErrorMsg := "4351898: Êï∞ÊçÆÂ∫ìË¢´ÈîÅÂÆö"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    ; È™åËØÅË°®ÂêçÂêàÊ≥ïÊÄßÔºàÈò≤Ê≠¢SQLÊ≥®ÂÖ•Ôºâ
    if (TableName = "" || RegExMatch(TableName, "[;'\[\]]")) {
        Result.ErrorMsg := "ERROR_202552: Ë°®ÂêçÈùûÊ≥ï: " . TableName
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    ; È™åËØÅ‰∏ªË°®ÊòØÂê¶Â≠òÂú®ÔºàÊ≥®ÂÜåÁôªËÆ∞‰∏ªË°®Ôºâ
    EscapedTableName := StrReplace(TableName, "'", "''")
    CheckMainTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . EscapedTableName . "';"
    MainTableResult := {}
    if (!SQLiteDB.GetTable(CheckMainTableSQL, MainTableResult) || MainTableResult.RowCount = 0) {
        Result.ErrorMsg := "ERROR_202553: ‰∏ªË°® " . TableName . " ‰∏çÂ≠òÂú®"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    ; È™åËØÅIDÊòØÂê¶Â≠òÂú®‰∫é‰∏ªË°®‰∏≠
    CheckDataIDSQL := "SELECT ID FROM [" . EscapedTableName . "] WHERE ID = " . DataID . " LIMIT 1;"
    DataIDResult := {}
    if (!SQLiteDB.GetTable(CheckDataIDSQL, DataIDResult) || DataIDResult.RowCount = 0) {
        Result.ErrorMsg := "ERROR_6247458: ID " . DataID . " Âú®Ë°® " . TableName . " ‰∏≠‰∏çÂ≠òÂú®"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    PropTableName := TableName . "_ÂÖ≥ËÅîÂ±ûÊÄß"

    ; Ê£ÄÊü•ÂÖ≥ËÅîÂ±ûÊÄßË°®ÊòØÂê¶Â≠òÂú®
    CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTableName . "';"
    PropTableResult := {}
    if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
        Result.ErrorMsg := "ERROR_5354041: Â±ûÊÄßÂÖ≥ËÅîË°® " . PropTableName . " ‰∏çÂ≠òÂú®"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }
    ; AddDebugLog("Â±ûÊÄßÂÖ≥ËÅîË°®Ê£ÄÊü•ÈÄöËøá: " . PropTableName)

    AttrFormat := Trim(AttrFormat)
    AttrValue := Trim(AttrValue)

    if (AttrFormat = "" || AttrValue = "") {
        Result.Success := 1
        Result.ErrorMsg := "Â±ûÊÄßÊ†ºÂºèÊàñÂÄº‰∏∫Á©∫ÔºåË∑≥Ëøá"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    if (StrLen(AttrValue) > 1000) {
        AttrValue := SubStr(AttrValue, 1, 1000)
    }

    if (AttrFormat = "ÊòüÁ∫ß" && AttrValue = "0") {
        Result.Success := 1
        Result.ErrorMsg := "ÊòüÁ∫ß‰∏∫ 0ÔºåË∑≥ËøáÊèíÂÖ•"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    EscapedAttrFormat := StrReplace(AttrFormat, "'", "''")
    EscapedAttrValue := StrReplace(AttrValue, "'", "''")
    EscapedDataFormat := StrReplace(DataFormat, "'", "''")
    
    ; Ê£ÄÊü•Â±ûÊÄßÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÂú®ÂÖ®Â±ÄÂÖ≥ËÅîÂ±ûÊÄßË°®‰∏≠Ôºâ
    GetAttrIDSQL := "SELECT Local_ID, ID FROM ÂÖ≥ËÅîÂ±ûÊÄßË°® WHERE Â±ûÊÄßÁ±ªÂûã = '" . EscapedAttrFormat . "' AND Â±ûÊÄßÂÄº = '" . EscapedAttrValue . "' LIMIT 1;"
    AttrResult := {}
    AttrID := ""
    
    SQLiteDB.Exec("PRAGMA busy_timeout = 5000;")

    if (SQLiteDB.GetTable(GetAttrIDSQL, AttrResult) && AttrResult.RowCount > 0) {
        AttrID := AttrResult.Rows[1][2]  ; Ëé∑Âèñ ID Â≠óÊÆµÔºàTEXTÔºâ
        ; AddDebugLog("ÊâæÂà∞Áé∞ÊúâÂ±ûÊÄß ID: " . AttrID)
    } else {
        ; AddDebugLog("Êú™ÊâæÂà∞Áé∞ÊúâÂ±ûÊÄß, ÂáÜÂ§áÊèíÂÖ•Êñ∞Â±ûÊÄß")
        ; ÊèíÂÖ•Êó∂ÂåÖÂê´Ê†ºÂºèÂ≠óÊÆµ
        if (DataFormat != "") {
            InsertAttrSQL := "INSERT OR IGNORE INTO ÂÖ≥ËÅîÂ±ûÊÄßË°® (Â±ûÊÄßÁ±ªÂûã, Â±ûÊÄßÂÄº, Á±ªÂûã) VALUES ('" . EscapedAttrFormat . "', '" . EscapedAttrValue . "', '" . EscapedDataFormat . "');"
        } else {
            InsertAttrSQL := "INSERT OR IGNORE INTO ÂÖ≥ËÅîÂ±ûÊÄßË°® (Â±ûÊÄßÁ±ªÂûã, Â±ûÊÄßÂÄº) VALUES ('" . EscapedAttrFormat . "', '" . EscapedAttrValue . "');"
        }
        
        RetryCount := 5
        Success := false
        while (RetryCount > 0) {
            if (SQLiteDB.Exec(InsertAttrSQL)) {
                Success := true
                ; AddDebugLog("ÊèíÂÖ•ÂÖ≥ËÅîÂ±ûÊÄßË°®ÊàêÂäü")
                break
            }
            ErrorMsg := SQLiteDB._ErrMsg()
            ; AddDebugLog("ÊèíÂÖ•ÂÖ≥ËÅîÂ±ûÊÄßË°®Â§±Ë¥• (ÈáçËØï " . (6-RetryCount) . "): " . ErrorMsg)
            if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                Sleep, 200
                RetryCount--
                continue
            }
            Result.ErrorMsg := "ERROR_202548: ÊèíÂÖ•ÂÖ≥ËÅîÂ±ûÊÄßË°®Â§±Ë¥•: " . ErrorMsg
            Return Result
        }
        
        if (!Success) {
            Result.ErrorMsg := "ERROR_202548: ÊèíÂÖ•ÂÖ≥ËÅîÂ±ûÊÄßË°®Â§±Ë¥•ÔºåË∂ÖËøáÈáçËØïÊ¨°Êï∞"
            ; AddDebugLog(Result.ErrorMsg)
            Return Result
        }
        
        ; Ëé∑ÂèñÊñ∞ÊèíÂÖ•ÁöÑ Local_ID Âíå ID
        GetAttrIDSQL := "SELECT Local_ID, ID FROM ÂÖ≥ËÅîÂ±ûÊÄßË°® WHERE Â±ûÊÄßÁ±ªÂûã = '" . EscapedAttrFormat . "' AND Â±ûÊÄßÂÄº = '" . EscapedAttrValue . "' LIMIT 1;"
        RetryCount := 5
        while (RetryCount > 0) {
            if (SQLiteDB.GetTable(GetAttrIDSQL, AttrResult) && AttrResult.RowCount > 0) {
                AttrID := AttrResult.Rows[1][2]  ; Ëé∑Âèñ ID Â≠óÊÆµ
                if (AttrID = "") {
                    AttrID := AttrResult.Rows[1][1]  ; Â¶ÇÊûú ID ‰∏∫Á©∫Ôºå fallback Âà∞ Local_ID
                    ; Êõ¥Êñ∞ ID Â≠óÊÆµ‰∏∫ Local_ID ÁöÑÊñáÊú¨ÂΩ¢Âºè
                    UpdateIDSQL := "UPDATE ÂÖ≥ËÅîÂ±ûÊÄßË°® SET ID = '" . AttrID . "' WHERE Local_ID = " . AttrResult.Rows[1][1] . ";"
                    if (!SQLiteDB.Exec(UpdateIDSQL)) {
                        ErrorMsg := SQLiteDB._ErrMsg()
                        Result.ErrorMsg := "ERROR_202549: Êõ¥Êñ∞Â±ûÊÄß ID Â§±Ë¥•: " . ErrorMsg
                        ; AddDebugLog(Result.ErrorMsg)
                        Return Result
                    }
                    ; AddDebugLog("Êõ¥Êñ∞Â±ûÊÄß ID ÊàêÂäü: " . AttrID)
                }
                ; AddDebugLog("Ëé∑ÂèñÊñ∞Â±ûÊÄß ID: " . AttrID)
                break
            }
            Sleep, 100
            RetryCount--
        }
        
        if (AttrID = "") {
            Result.ErrorMsg := "ERROR_202549: ÊèíÂÖ•ÂêéÊú™ÊâæÂà∞Â±ûÊÄß IDÔºåÂ±ûÊÄßÁ±ªÂûã='" . AttrFormat . "', Â±ûÊÄßÂÄº='" . AttrValue . "'"
            ; AddDebugLog(Result.ErrorMsg)
            Return Result
        }
    }

    if (AttrID = "") {
        Result.ErrorMsg := "ERROR_202549: Êó†ÊïàÁöÑÂ±ûÊÄß ID"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    ; Ê£ÄÊü•Â±ûÊÄßÂÖ≥ËÅîÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÂä®ÊÄÅPropTableNameÔºâ
    EscapedPropTable := StrReplace(PropTableName, "'", "''")
    CheckExistSQL := "SELECT COUNT(*) FROM [" . EscapedPropTable . "] WHERE Â±ûÊÄßID = '" . StrReplace(AttrID, "'", "''") . "' AND ID = " . DataID . ";"
    CheckResult := {}
    ExistingCount := 0
    
    if (SQLiteDB.GetTable(CheckExistSQL, CheckResult) && CheckResult.RowCount > 0) {
        ExistingCount := CheckResult.Rows[1][1]
        if (ExistingCount > 0) {
            Result.Success := 1
            Result.ErrorMsg := "Â±ûÊÄßÂÖ≥ËÅîÂ∑≤Â≠òÂú®"
            Result.AttrID := AttrID
            ; AddDebugLog("Â±ûÊÄßÂÖ≥ËÅîÂ∑≤Â≠òÂú®")
            Return Result
        }
    } else {
        ErrorMsg := SQLiteDB._ErrMsg()
        Result.ErrorMsg := "ERROR_3744312: Ê£ÄÊü•Â±ûÊÄßÂÖ≥ËÅîÂ§±Ë¥•: " . ErrorMsg
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }
    ; AddDebugLog("Â±ûÊÄßÂÖ≥ËÅî‰∏çÂ≠òÂú®, ÂáÜÂ§áÊèíÂÖ•")

    ; ÊèíÂÖ•Â±ûÊÄßÂÖ≥ËÅîÊó∂‰πüÂåÖÂê´Ê†ºÂºèÂ≠óÊÆµ
    if (DataFormat != "") {
        InsertAssocSQL := "INSERT INTO [" . EscapedPropTable . "] (Â±ûÊÄßID, ID, Ê†ºÂºè) VALUES ('" . StrReplace(AttrID, "'", "''") . "', " . DataID . ", '" . EscapedDataFormat . "');"
    } else {
        InsertAssocSQL := "INSERT INTO [" . EscapedPropTable . "] (Â±ûÊÄßID, ID) VALUES ('" . StrReplace(AttrID, "'", "''") . "', " . DataID . ");"
    }
    
    RetryCount := 5
    Success := false
    while (RetryCount > 0) {
        if (SQLiteDB.Exec(InsertAssocSQL)) {
            Success := true
            ; AddDebugLog("ÊèíÂÖ•Â±ûÊÄßÂÖ≥ËÅîÊàêÂäü")
            break
        }
        ErrorMsg := SQLiteDB._ErrMsg()
        ; AddDebugLog("ÊèíÂÖ•Â±ûÊÄßÂÖ≥ËÅîÂ§±Ë¥• (ÈáçËØï " . (6-RetryCount) . "): " . ErrorMsg)
        if (InStr(ErrorMsg, "SQLITE_BUSY")) {
            Sleep, 200
            RetryCount--
            continue
        }
        Result.ErrorMsg := "2716957: ÊèíÂÖ•Â±ûÊÄßÂÖ≥ËÅîÂ§±Ë¥•: " . ErrorMsg
        Return Result
    }
    
    if (!Success) {
        Result.ErrorMsg := "2720504: ÊèíÂÖ•Â±ûÊÄßÂÖ≥ËÅîÂ§±Ë¥•ÔºåË∂ÖËøáÈáçËØïÊ¨°Êï∞"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    Result.Success := 1
    Result.ErrorMsg := ""
    Result.AttrID := AttrID
    ; AddDebugLog("InsertAttribute ÂÆåÊàêÊàêÂäü, TableName=" . TableName . ", AttrID=" . AttrID)
    Return Result
}

VerifyAllAttributes(DataID, TableName) {
    Global SQLiteDB
    
    AttrCount := 0
    
    ; Ê£ÄÊü•‰∏ªË°®ÊòØÂê¶Â≠òÂú®
    EscapedTableName := StrReplace(TableName, "'", "''")
    CheckMainTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . EscapedTableName . "';"
    MainTableResult := {}
    if (!SQLiteDB.GetTable(CheckMainTableSQL, MainTableResult) || MainTableResult.RowCount = 0) {
        MsgBox, 16, ÈîôËØØ, VerifyAllAttributes: ‰∏ªË°® " . TableName . " ‰∏çÂ≠òÂú®
        Return -1
    }
    
    ; Ê£ÄÊü• DataID ÊòØÂê¶Â≠òÂú®
    CheckDataIDSQL := "SELECT ID FROM [" . EscapedTableName . "] WHERE ID = " . DataID . " LIMIT 1;"
    DataIDResult := {}
    if (!SQLiteDB.GetTable(CheckDataIDSQL, DataIDResult) || DataIDResult.RowCount = 0) {
        MsgBox, 16, ÈîôËØØ, VerifyAllAttributes: ID " . DataID . " Âú®Ë°® " . TableName . " ‰∏≠‰∏çÂ≠òÂú®
        Return -1
    }
    
    ; Ê£ÄÊü•Â±ûÊÄßÂÖ≥ËÅîË°®ÊòØÂê¶Â≠òÂú®
    PropTableName := TableName . "_ÂÖ≥ËÅîÂ±ûÊÄß"
    CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTableName . "';"
    PropTableResult := {}
    if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
        MsgBox, 16, ÈîôËØØ, VerifyAllAttributes: Â±ûÊÄßÂÖ≥ËÅîË°® " . PropTableName . " ‰∏çÂ≠òÂú®
        Return -1
    }
    
    Return AttrCount
}


ClipboardChangedTip() {
    CoordMode, Tooltip, Windows
    MouseGetPos, x, y

    message := "Â∑≤ÊàêÂäüÂàõÂª∫Êï∞ÊçÆÔºÅ"

    Loop, 2 {
        Tooltip, %message%, x0, y-50
        Sleep, 100
        Tooltip
    }
    Tooltip, %message%, x0, y-50
    Sleep, 1500
    Tooltip
}

BeginSafeTransaction(context) {
    Global SQLiteDB, TransactionActive, TransactionOwner
    if (TransactionActive) {
        ; AddDebugLog("‰∫ãÂä°Â∑≤Ê¥ªË∑ÉÔºå‰∏ä‰∏ãÊñá: " . TransactionOwner . "ÔºåË∑≥Ëøá BEGIN")
        Return true  ; ÂÖÅËÆ∏ÂµåÂ•óÔºå‰ΩÜ‰∏çÈ¢ùÂ§ñ BEGINÔºàSQLite Áî® SAVEPOINTÔºâ
    }
    ; AddDebugLog("ÊâßË°å BEGIN TRANSACTION")
    if (!SQLiteDB.Exec("BEGIN TRANSACTION;")) {
        ErrorMsg := SQLiteDB._ErrMsg()
        ; AddDebugLog("BEGIN ÊâßË°åÂ§±Ë¥•: " . ErrorMsg)
        Return false
    }
    TransactionActive := true
    TransactionOwner := context
    ; AddDebugLog("‰∫ãÂä°ÂºÄÂßãÊàêÂäüÔºåOwner: " . context)
    Return true
}

CommitSafeTransaction(context) {
    Global SQLiteDB, TransactionActive, TransactionOwner
    if (!TransactionActive) {
        ; AddDebugLog("Êó†Ê¥ªË∑É‰∫ãÂä°ÔºåÊó†Ê≥ï COMMIT")
        Return false
    }
    if (TransactionOwner != context) {
        ; AddDebugLog("‰∏ä‰∏ãÊñá‰∏çÂåπÈÖç: ÂΩìÂâç " . TransactionOwner . "ÔºåÈ¢ÑÊúü " . context)
        Return false
    }
    ; AddDebugLog("ÊâßË°å COMMIT")
    if (!SQLiteDB.Exec("COMMIT;")) {
        ErrorMsg := SQLiteDB._ErrMsg()
        ; AddDebugLog("COMMIT ÊâßË°åÂ§±Ë¥•: " . ErrorMsg)
        Return false
    }
    TransactionActive := false
    TransactionOwner := ""
    ; AddDebugLog("‰∫ãÂä°Êèê‰∫§ÊàêÂäü")
    Return true
}

RollbackSafeTransaction(context) {
    Global SQLiteDB, TransactionActive, TransactionOwner
    if (!TransactionActive) {
        ; AddDebugLog("Êó†Ê¥ªË∑É‰∫ãÂä°ÔºåË∑≥Ëøá ROLLBACK")
    } else if (TransactionOwner != context) {
        ; AddDebugLog("‰∏ä‰∏ãÊñá‰∏çÂåπÈÖçÔºåË∑≥Ëøá ROLLBACK")
    } else {
        ; AddDebugLog("ÊâßË°å ROLLBACK")
        SQLiteDB.Exec("ROLLBACK;")
    }
    TransactionActive := false
    TransactionOwner := ""
    ; AddDebugLog("‰∫ãÂä°ÂõûÊªöÂÆåÊàêÔºåÈáçÁΩÆÊ†áÂøó")
    Return true
}

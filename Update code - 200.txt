; ä¸€ æ—§ç‰ˆæœ¬
ClipboardChanged(type) {
    Global SQLiteDB, DBPath, IsCopying, ClipboardLock, ProcessingContext, TransactionActive, TransactionOwner, G_last_insert_rowid, G_last_insert_Main_ID, G_last_insert_Main_TableName
	; ğŸ”¥ æ·»åŠ è¿™ä¸ªæ£€æŸ¥ - ä»»ä½•éé›¶çš„ ClipboardLock éƒ½åº”è¯¥é˜»æ­¢æ‰§è¡Œ
    if (ClipboardLock != 0) {
        Return
    }
  
    WinGet, ActiveID, ID, A
    WinGetTitle, WindowTitle, ahk_id %ActiveID%
    if (InStr(WindowTitle, "å°è±¡è®°å¿†_5")) {
        Return
    }
    if (type != 1 && type != 2) {
        Return
    }
    ClipboardLock := 3
    ProcessingContext := "Clipboard"
    FinalID := ""
    try {
        ; ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“åˆå§‹åŒ–æ–¹æ³•
        if (!InitDB(DBPath)) {
            LoadData()
            Return
        }
        
        ; ğŸ”¥ æµ‹è¯•æ•°æ®åº“æ˜¯å¦å¯å†™ï¼ˆé˜²æ­¢è¢«å ç”¨ï¼‰
        TestWriteSQL := "CREATE TEMP TABLE IF NOT EXISTS _test_write (id INTEGER); DROP TABLE IF EXISTS _test_write;"
        if (!SQLiteDB.Exec(TestWriteSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4103698 æ•°æ®åº“è¢«å ç”¨æˆ–æ— å†™å…¥æƒé™`n`né”™è¯¯: %ErrorMsg%`nè·¯å¾„: %DBPath%
            LoadData()
            Return
        }
		
        ; æ ¹æ®å‰ªè´´æ¿å†…å®¹åŠ¨æ€å†³å®šä¸»è¡¨åç§°
        isFileSystemContent := false
        if (DllCall("IsClipboardFormatAvailable", "UInt", 15)) { ; CF_HDROP
            isFileSystemContent := true
        } else {
            TempClipData := Clipboard
            TempClipData := Trim(RegExReplace(TempClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", ""))
            if (TempClipData != "") {
                lines := StrSplit(TempClipData, "`n")
                FirstLine := Trim(lines[1])
                if (RegExMatch(FirstLine, "^[A-Za-z]:\\.*$") || RegExMatch(FirstLine, "^\\\\.*$")) {
                    isFileSystemContent := true
                }
            }
        }

        if (isFileSystemContent) {
            MainTable := "Database"
        } else {
            MainTable := "å†å²æ•°æ®"
        }
		
        OldMainTable := MainTable . "_temp_old"
        DataTable := "Data_" . MainTable
        OldDataTable := DataTable . "_temp_old"
        PropTable := MainTable . "_å…³è”å±æ€§"
        OldPropTable := PropTable . "_temp_old"
        SQLiteDB.Exec("PRAGMA foreign_keys = OFF;")
        CheckMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . MainTable . "';"
        MainResult := {}
        if (SQLiteDB.GetTable(CheckMainSQL, MainResult) && MainResult.RowCount = 0) {
            CheckOldMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldMainTable . "';"
            OldMainResult := {}
            if (SQLiteDB.GetTable(CheckOldMainSQL, OldMainResult) && OldMainResult.RowCount > 0) {
                RenameMainSQL := "ALTER TABLE [" . OldMainTable . "] RENAME TO [" . MainTable . "];"
                if (SQLiteDB.Exec(RenameMainSQL)) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4111311 æ— æ³•æ¢å¤ä¸»è¡¨: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            } else {
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4113412 ä¸»è¡¨ç¼ºå¤±ä¸”æ— å¤‡ä»½ï¼
                SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                LoadData()
                Return
            }
        } else {
            CheckOldMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldMainTable . "';"
            OldMainResult := {}
            if (SQLiteDB.GetTable(CheckOldMainSQL, OldMainResult) && OldMainResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldMainTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        CheckDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . DataTable . "';"
        DataResult := {}
        if (SQLiteDB.GetTable(CheckDataSQL, DataResult) && DataResult.RowCount = 0) {
            CheckOldDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldDataTable . "';"
            OldDataResult := {}
            if (SQLiteDB.GetTable(CheckOldDataSQL, OldDataResult) && OldDataResult.RowCount > 0) {
                RenameDataSQL := "ALTER TABLE [" . OldDataTable . "] RENAME TO [" . DataTable . "];"
                if (SQLiteDB.Exec(RenameDataSQL)) {
                    AlterDataSQL := "ALTER TABLE [" . DataTable . "] ADD FOREIGN KEY(lParentID) REFERENCES [" . MainTable . "](ID);"
                    SQLiteDB.Exec(AlterDataSQL)
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4119130 æ— æ³•æ¢å¤æ•°æ®è¡¨: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            }
        } else {
            CheckOldDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldDataTable . "';"
            OldDataResult := {}
            if (SQLiteDB.GetTable(CheckOldDataSQL, OldDataResult) && OldDataResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldDataTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        CheckPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTable . "';"
        PropResult := {}
        if (SQLiteDB.GetTable(CheckPropSQL, PropResult) && PropResult.RowCount = 0) {
            CheckOldPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldPropTable . "';"
            OldPropResult := {}
            if (SQLiteDB.GetTable(CheckOldPropSQL, OldPropResult) && OldPropResult.RowCount > 0) {
                RenamePropSQL := "ALTER TABLE [" . OldPropTable . "] RENAME TO [" . PropTable . "];"
                if (SQLiteDB.Exec(RenamePropSQL)) {
                    AlterPropFK1SQL := "ALTER TABLE [" . PropTable . "] ADD FOREIGN KEY(å±æ€§ID) REFERENCES å…³è”å±æ€§è¡¨(ID);"
                    AlterPropFK2SQL := "ALTER TABLE [" . PropTable . "] ADD FOREIGN KEY(ID) REFERENCES [" . MainTable . "](ID) ON DELETE CASCADE;"
                    SQLiteDB.Exec(AlterPropFK1SQL)
                    SQLiteDB.Exec(AlterPropFK2SQL)
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4127581 æ— æ³•æ¢å¤å±æ€§è¡¨: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            }
        } else {
            CheckOldPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldPropTable . "';"
            OldPropResult := {}
            if (SQLiteDB.GetTable(CheckOldPropSQL, OldPropResult) && OldPropResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldPropTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å…³è”å±æ€§è¡¨';"
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTable . "';"
        CheckMainTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . MainTable . "';"
        AssocTableResult := {}
        PropTableResult := {}
        MainTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4133064 å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            LoadData()
            Return
        }
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4135569, A_Space . PropTable . " è¡¨ä¸å­˜åœ¨ï¼"
            LoadData()
            Return
        }
        if (!SQLiteDB.GetTable(CheckMainTableSQL, MainTableResult) || MainTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4140580, A_Space . MainTable . " è¡¨ä¸å­˜åœ¨ï¼"
            LoadData()
            Return
        }
        GetColumnsSQL := "PRAGMA table_info(" . MainTable . ");"
        ColumnsResult := {}
        RequiredFields := ["å¤‡æ³¨", "å†…å®¹", "ç½®é¡¶", "ç½®é¡¶ç´¢å¼•", "æ”¶è—", "ç¦åˆ ", "æ˜Ÿçº§", "æ ‡ç­¾", "åˆ†ç»„", "ç±»å‹", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹æ—¶é—´", "è®¿é—®æ—¶é—´", "è®¿é—®æ¬¡æ•°", "æ›´æ–°æ¬¡æ•°", "å­—èŠ‚", "å­—ç¬¦", "è¡Œæ•°", "æ•°é‡", "æ ‡è¯†", "çª—å£è¯¦æƒ…", "åº”ç”¨åç§°", "å“ˆå¸Œå€¼", "æ’åº", "æ ‡è®°çŠ¶æ€"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4146625, A_Space . MainTable . "è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%"
                LoadData()
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4149159 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
            LoadData()
            Return
        }
        Sleep, 100
        ClipData := ""
        Format := ""
        DataType := 1
        Identifier := ""
        FileCount := 0
        ValidCount := 0
        TotalSize := 0
        Bytes := ""
        Group := ""
        Remark := ""
        AllPaths := []
        FolderPath := ""
        if (!BeginSafeTransaction("ClipboardChanged")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1938940 å¼€å§‹äº‹åŠ¡å¤±è´¥ï¼
            LoadData()
            Return
        }
        if (DllCall("IsClipboardFormatAvailable", "UInt", 15)) {
            Format := "CF_HDROP"
            ClipData := Clipboard
            FilePathsList := ""
          
            Loop, Parse, Clipboard, `n, `r
            {
                Path := Trim(A_LoopField)
                if (Path != "" && FileExist(Path)) {
                    AllPaths.Push(Path)
                    FileCount++
                }
            }
          
            if (FileCount = 0) {
                RollbackSafeTransaction("ClipboardChanged")
                LoadData()
                Return
            }
          
            Path := AllPaths[1]
            FileAttrib := FileExist(Path)
            isFolderMode := InStr(FileAttrib, "D")
          
            SplitPath, Path, FileName, FileDir, FileExt, FileNameNoExt
            GroupName := ""
            if (FileDir) {
                SplitPath, FileDir, GroupName
            }
            Group := GroupName
          
            if (isFolderMode) {
                Loop, % AllPaths.MaxIndex() {
                    CurrentPath := AllPaths[A_Index]
                    CurrentAttrib := FileExist(CurrentPath)
                    if (!InStr(CurrentAttrib, "D")) {
                        continue
                    }
                  
                    ; ğŸ”¥ æ”¶é›†å½“å‰æ–‡ä»¶å¤¹çš„ç¬¬ä¸€å±‚å­æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
                    FirstLevelFolders := []
                    FirstLevelFiles := []
                    
                    ; å…ˆæ”¶é›†å­æ–‡ä»¶å¤¹
                    Loop, Files, %CurrentPath%\\*.*, D
                    {
                        FirstLevelFolders.Push(A_LoopFileFullPath)
                    }
                    
                    ; å†æ”¶é›†ç›´æ¥æ–‡ä»¶
                    Loop, Files, %CurrentPath%\\*.*, F
                    {
                        FirstLevelFiles.Push(A_LoopFileFullPath)
                    }
                    
                    ; ğŸ”¥ ä¸ºæ¯ä¸ªå­æ–‡ä»¶å¤¹å•ç‹¬åˆ›å»ºè®°å½•
                    Loop, % FirstLevelFolders.Length() {
                        SubFolderPath := FirstLevelFolders[A_Index]
                        
                        LocalValidCount := 0
                        LocalTotalSize := 0
                        LocalFilePathsList := ""
                        
                        ; æ”¶é›†å­æ–‡ä»¶å¤¹çš„ç¬¬ä¸€å±‚å†…å®¹
                        Loop, Files, %SubFolderPath%\\*.*, D
                        {
                            LocalFilePathsList .= A_LoopFileFullPath . "`n"
                            LocalValidCount++
                            
                            ; é€’å½’è®¡ç®—å¤§å°
                            Loop, Files, %A_LoopFileFullPath%\\*.*, FR
                            {
                                FileGetSize, FileSize, %A_LoopFileFullPath%, B
                                LocalTotalSize += FileSize
                            }
                        }
                        
                        Loop, Files, %SubFolderPath%\\*.*, F
                        {
                            LocalFilePathsList .= A_LoopFileFullPath . "`n"
                            LocalValidCount++
                            FileGetSize, FileSize, %A_LoopFileFullPath%, B
                            LocalTotalSize += FileSize
                        }
                        
                        LocalFilePathsList := RTrim(LocalFilePathsList, "`n")
                        LocalClipData := LocalFilePathsList
                      
                        LocalSizeStr := ""
                        if (LocalTotalSize > 0) {
                            if (LocalTotalSize < 1024)
                                LocalSizeStr := LocalTotalSize . " B"
                            else if (LocalTotalSize < 1024 * 1024)
                                LocalSizeStr := Round(LocalTotalSize / 1024,2) . " KB"
                            else if (LocalTotalSize < 1024 * 1024 * 1024)
                                LocalSizeStr := Round(LocalTotalSize / (1024 * 1024),2) . " MB"
                            else
                                LocalSizeStr := Round(LocalTotalSize / (1024 * 1024 * 1024),2) . " GB"
                        }
                      
                        SplitPath, SubFolderPath, LocalFileName, LocalFileDir, , LocalFileNameNoExt
                        SplitPath, LocalFileDir, , , , LocalParentDir
                        LocalGroup := LocalFileDir ? LocalParentDir : ""
                      
                        LocalTempRemark := "Copied Folder - " . LocalFileNameNoExt . " | æ•°é‡: 1 | æœ‰æ•ˆ: " . LocalValidCount . " | å¤§å°: " . LocalSizeStr
                        LocalContent := LocalTempRemark
                        LocalRemark := SubFolderPath
                      
                        LocalIdentifier := "ğŸ“"
                        LocalFormat := "CF_HDROP,ğŸ“"
                      
                        ClipData := LocalClipData
                        Content := LocalContent
                        Remark := LocalRemark
                        Identifier := LocalIdentifier
                        Format := LocalFormat
                        Group := LocalGroup
                      
                        gosub, InsertCommon
                        if (FinalID = "" || FinalID <= 0) {
                            return
                        }
                    }
                    
                    ; ğŸ”¥ å¦‚æœçˆ¶æ–‡ä»¶å¤¹æœ‰ç›´æ¥æ–‡ä»¶ï¼Œä¸ºè¿™äº›æ–‡ä»¶åˆ›å»ºä¸€æ¡è®°å½•
                    if (FirstLevelFiles.Length() > 0) {
                        LocalValidCount := FirstLevelFiles.Length()
                        LocalTotalSize := 0
                        LocalFilePathsList := ""
                        
                        Loop, % FirstLevelFiles.Length() {
                            FilePath := FirstLevelFiles[A_Index]
                            LocalFilePathsList .= FilePath . "`n"
                            FileGetSize, FileSize, %FilePath%, B
                            LocalTotalSize += FileSize
                        }
                        
                        LocalFilePathsList := RTrim(LocalFilePathsList, "`n")
                        LocalClipData := LocalFilePathsList
                      
                        LocalSizeStr := ""
                        if (LocalTotalSize > 0) {
                            if (LocalTotalSize < 1024)
                                LocalSizeStr := LocalTotalSize . " B"
                            else if (LocalTotalSize < 1024 * 1024)
                                LocalSizeStr := Round(LocalTotalSize / 1024,2) . " KB"
                            else if (LocalTotalSize < 1024 * 1024 * 1024)
                                LocalSizeStr := Round(LocalTotalSize / (1024 * 1024),2) . " MB"
                            else
                                LocalSizeStr := Round(LocalTotalSize / (1024 * 1024 * 1024),2) . " GB"
                        }
                      
                        SplitPath, CurrentPath, LocalFileName, LocalFileDir, , LocalFileNameNoExt
                        SplitPath, LocalFileDir, , , , LocalParentDir
                        LocalGroup := LocalFileDir ? LocalParentDir : ""
                      
                        LocalTempRemark := "Copied Files from - " . LocalFileNameNoExt . " | æ•°é‡: " . LocalValidCount . " | æœ‰æ•ˆ: " . LocalValidCount . " | å¤§å°: " . LocalSizeStr
                        LocalContent := LocalTempRemark
                        LocalRemark := CurrentPath
                      
                        LocalIdentifier := "ğŸ“"
                        LocalFormat := "CF_HDROP,ğŸ“"
                      
                        ClipData := LocalClipData
                        Content := LocalContent
                        Remark := LocalRemark
                        Identifier := LocalIdentifier
                        Format := LocalFormat
                        Group := LocalGroup
                      
                        gosub, InsertCommon
                        if (FinalID = "" || FinalID <= 0) {
                            return
                        }
                    }
                }
            } else {
                ValidCount := 0
                TotalSize := 0
                FilePathsList := ""
                
                UniqueIdentifiers := {}
                UniqueExts := {}

                Loop, % AllPaths.MaxIndex() {
                    CurrentPath := AllPaths[A_Index]
                    FilePathsList .= CurrentPath . "`n"
                    FileGetSize, FileSize, %CurrentPath%, B
                    TotalSize += FileSize
                    ValidCount++
                    
                    SplitPath, CurrentPath, , , FileExt
                    
                    Symbol := GetFileTypeSymbol(CurrentPath, FileExt)
                    if (Symbol != "") {
                        SymbolsList := StrSplit(Symbol, ",")
                        for _, s in SymbolsList {
                            UniqueIdentifiers[s] := 1
                        }
                    }
                    if (FileExt != "") {
                        UniqueExts[FileExt] := 1
                    }
                }
                FilePathsList := RTrim(FilePathsList, "`n")
                ClipData := FilePathsList

                IdentifierStr := ""
                for k, v in UniqueIdentifiers {
                    IdentifierStr .= k . ","
                }
                Identifier := RTrim(IdentifierStr, ",")

                Format := "CF_HDROP"
                if (Identifier != "") {
                    Format .= "," . Identifier
                }
                ExtStr := ""
                for k, v in UniqueExts {
                    ExtStr .= k . ","
                }
                ExtStr := RTrim(ExtStr, ",")

                if (ExtStr != "") {
                    Format .= "," . ExtStr
                }
              
                SizeStr := ""
                if (TotalSize > 0) {
                    if (TotalSize < 1024)
                        SizeStr := TotalSize . " B"
                    else if (TotalSize < 1024 * 1024)
                        SizeStr := Round(TotalSize / 1024,2) . " KB"
                    else if (TotalSize < 1024 * 1024 * 1024)
                        SizeStr := Round(TotalSize / (1024 * 1024),2) . " MB"
                    else
                        SizeStr := Round(TotalSize / (1024 * 1024 * 1024),2) . " GB"
                }
              
                Path := AllPaths[1] ; For remark only
                SplitPath, Path, FileName, , , FileNameNoExt

                TempRemark := "Copied File - " . FileNameNoExt . " | æ•°é‡: " . FileCount . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
                Content := TempRemark
                Remark := FileName
              
                gosub, InsertCommon
                if (FinalID = "" || FinalID <= 0) {
                    return
                }
            }
        } else {
            ClipData := Clipboard
            Format := "CF_UNICODETEXT"
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || RegExMatch(ClipData, "^\s*$")) {
                RollbackSafeTransaction("ClipboardChanged")
                LoadData()
                Return
            }
            if (StrLen(ClipData) > 5000000) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4159040 æ–‡æœ¬å‰ªè´´æ¿å†…å®¹è¿‡å¤§ï¼ˆè¶…è¿‡ 5MBï¼‰ï¼
                LoadData()
                Return
            }
            lines := StrSplit(ClipData, "`n")
            FirstLine := Trim(lines[1])
            if (RegExMatch(FirstLine, "^[A-Za-z]:\\.*$") || RegExMatch(FirstLine, "^\\\\.*$")) {
                FirstAttrib := FileExist(FirstLine)
                SplitPath, FirstLine, FileName, FileDir, FileExt, FileNameNoExt
                if (InStr(FirstAttrib, "D")) {
                    Identifier := "ğŸ“ğ“Ÿ"
                    Format := "CF_UNICODETEXT,ğŸ“ğ“Ÿ"
                } else {
                    ; ä½¿ç”¨ GetFileTypeSymbol å‡½æ•°è·å–æ ‡è¯†ç¬¦
                    Identifier := GetFileTypeSymbol(FirstLine, FileExt) . "ğ“Ÿ"
                    Format := "CF_UNICODETEXT," . Identifier
                    if (FileExt != "") {
                        Format .= "," . FileExt
                    }
                }
                FileCount := 0
                ValidCount := 0
                TotalSize := 0
                Loop, % lines.Length() {
                    Path := Trim(lines[A_Index])
                    if (Path != "" && FileExist(Path)) {
                        FileAttrib := FileExist(Path)
                        FileCount++
                        if (InStr(FileAttrib, "D")) {
                            Loop, Files, %Path%\\*.*, F
                            {
                                if (FileExist(A_LoopFileFullPath)) {
                                    ValidCount++
                                    FileGetSize, FileSize, %A_LoopFileFullPath%, B
                                    TotalSize += FileSize
                                }
                            }
                        } else {
                            ValidCount++
                            FileGetSize, FileSize, %Path%, B
                            TotalSize += FileSize
                        }
                    }
                }
                SizeStr := ""
                if (TotalSize > 0) {
                    if (TotalSize < 1024)
                        SizeStr := TotalSize . " B"
                    else if (TotalSize < 1024 * 1024)
                        SizeStr := Round(TotalSize / 1024,2) . " KB"
                    else if (TotalSize < 1024 * 1024 * 1024)
                        SizeStr := Round(TotalSize / (1024 * 1024),2) . " MB"
                    else
                        SizeStr := Round(TotalSize / (1024 * 1024 * 1024),2) . " GB"
                }
                GroupName := ""
                if (FileDir) {
                    SplitPath, FileDir, GroupName
                }
                Group := GroupName
                if (InStr(FirstAttrib, "D")) {
                    TempRemark := "Copied Folder Path - " . FileNameNoExt . " | æ•°é‡: " . FileCount . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
                } else {
                    TempRemark := "Copied File Path - " . FileNameNoExt . " | æ•°é‡: " . FileCount . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
                }
                Content := RegExReplace(ClipData, "[\r\n]+", " ")
                Remark := Content
                Content := TempRemark
            } else {
                if (RegExMatch(ClipData, "^(https?|ftp)://[A-Za-z0-9\-\.]+(:[0-9]+)?(/[A-Za-z0-9\-\._~:/?#\[\]@!$&'()*+,;=%]*)?$")) {
                    Format := "CF_UNICODETEXT,ğŸ”—"
                    Identifier := "ğŸ”—"
                    Content := ClipData
                    if (RegExMatch(ClipData, "://([^/]+)", domainMatch)) {
                        fullDomain := domainMatch1
                        if (RegExMatch(fullDomain, "^(?:www\.)?([^.]+)\.[^.]+$", mainDomainMatch)) {
                            Remark := mainDomainMatch1
                        } else {
                            Remark := fullDomain
                        }
                    } else {
                        Remark := SubStr(ClipData, 1, 200)
                    }
                } else {
                    Remark := FirstLine
                    ByteCount := StrPut(ClipData, "UTF-8") - 1
                    if (ByteCount < 1024)
                        Bytes := ByteCount . " B"
                    else if (ByteCount < 1024 * 1024)
                        Bytes := Round(ByteCount / 1024,2) . " KB"
                    else if (ByteCount < 1024 * 1024 * 1024)
                        Bytes := Round(ByteCount / (1024 * 1024),2) . " MB"
                    else
                        Bytes := Round(ByteCount / (1024 * 1024 * 1024),2) . " GB"
                    CharCount := StrLen(ClipData)
                    LineCount := lines.Length()
                    Content := "[æ–‡æœ¬] | " . CharCount . " å­—ç¬¦ | " . Bytes . " | " . LineCount . " è¡Œ"
                }
            }
          
            gosub, InsertCommon
            if (FinalID = "" || FinalID <= 0) {
                return
            }
        }
        ; === åˆ†ç±»å­—å…¸_Oneï¼šæœ€åæ’å…¥IDï¼ˆç»Ÿä¸€ç»“æ„ï¼‰===
        DeleteRecordSQL := "DELETE FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æœ€åæ’å…¥ID' AND ""Category_Sub"" = 'æœ€åæ’å…¥ID';"
        SQLiteDB.Exec(DeleteRecordSQL)
        LastIDValue := (FinalID ? FinalID : "")
        InsertRecordSQL := "INSERT OR REPLACE INTO ""åˆ†ç±»å­—å…¸_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', ?, 1, datetime('now','localtime'));"
        if (SQLiteDB.ExecuteWithParams) {
            SQLiteDB.ExecuteWithParams(InsertRecordSQL, [LastIDValue])
        } else {
            EscapedLastID := StrReplace(LastIDValue, "'", "''")
            FallbackSQL := "INSERT OR REPLACE INTO ""åˆ†ç±»å­—å…¸_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', '" . EscapedLastID . "', 1, datetime('now','localtime'));"
            SQLiteDB.Exec(FallbackSQL)
        }
        if (!CommitSafeTransaction("ClipboardChanged")) {
            RollbackSafeTransaction("ClipboardChanged")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3828190 äº‹åŠ¡æäº¤å¤±è´¥ï¼
            LoadData()
            Return
        }
        AttrCount := VerifyAllAttributes(FinalID, MainTable)
        if (AttrCount < 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5020111 å±æ€§å…³è”éªŒè¯å¤±è´¥
        }
        return
    InsertCommon:
        HashValue := ""
        try {
            if (ClipData != "") {
                ; ğŸ”¥ æ·»åŠ æ•°æ®é•¿åº¦æ£€æŸ¥ï¼Œé¿å…å¤„ç†è¿‡å¤§æ•°æ®
                ClipDataLen := StrLen(ClipData)
                if (ClipDataLen > 10000000) {
                    ; è¶…è¿‡10MBçš„æ•°æ®ï¼Œä½¿ç”¨æˆªæ–­åçš„å†…å®¹è®¡ç®—å“ˆå¸Œ
                    TruncatedData := SubStr(ClipData, 1, 10000000)
                    HashValue := Crypt.Hash.Str(TruncatedData, "SHA256") . "_TRUNCATED"
                } else {
                    HashValue := Crypt.Hash.Str(ClipData, "SHA256")
                }
            }
        } catch e {
            eMessage := e.Message
            ; ğŸ”¥ å“ˆå¸Œè®¡ç®—å¤±è´¥æ—¶ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            HashValue := "HASH_FAILED_" . A_TickCount . "_" . StrLen(ClipData)
            ; ä¸å›æ»šäº‹åŠ¡ï¼Œç»§ç»­æ‰§è¡Œ
            ; MsgBox, 16, è­¦å‘Š, é”™è¯¯ IDï¼š5334156 è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: %eMessage%ï¼Œä½¿ç”¨å¤‡ç”¨å“ˆå¸Œå€¼
        }
        ; === ä½¿ç”¨åˆ†ç±»å­—å…¸_Oneè¡¨ç»´æŠ¤æ’åºæœ€å¤§å€¼ï¼ˆå¸¦å”¯ä¸€æ€§å¤„ç†ï¼‰===
        GetMaxSortSQL := "SELECT COALESCE(""Record_Value"", 0) FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' LIMIT 1;"
        MaxSortResult := {}
        CurrentMax := 0
        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
            CurrentMax := MaxSortResult.Rows[1][1] + 0 ; å¼ºåˆ¶è½¬ä¸ºæ•°å­—
        } else {
            ; åˆå§‹åŒ–
            InitSQL := "INSERT OR IGNORE INTO ""åˆ†ç±»å­—å…¸_One"" (""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                     . "VALUES ('æ’åºå€¼', 'æœ€å¤§å€¼', '0', 0, datetime('now','localtime'));"
            if (!SQLiteDB.Exec(InitSQL)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3646934 æ–°ID-æ’åºåˆå§‹åŒ–å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
            CurrentMax := 0
        }
        ; å¾ªç¯è·å–å”¯ä¸€æ’åºå€¼
        Loop {
            NewSortValue := CurrentMax + 1
            ; å°è¯•æ›´æ–°æœ€å¤§å€¼
            UpdateMaxSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = ?, ""Update_Time"" = datetime('now','localtime') "
                          . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = ?;"
            Success := false
            RetryCount := 3
            while (RetryCount > 0) {
                if (SQLiteDB.ExecuteWithParams) {
                    if (SQLiteDB.ExecuteWithParams(UpdateMaxSQL, [NewSortValue, CurrentMax])) {
                        Success := true
                        break
                    }
                } else {
                    FallbackSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = '" . NewSortValue . "', ""Update_Time"" = datetime('now','localtime') "
                                 . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = '" . CurrentMax . "';"
                    if (SQLiteDB.Exec(FallbackSQL)) {
                        Success := true
                        break
                    }
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 50
                    RetryCount--
                    continue
                }
                ; æ–°å¢ï¼šæ£€æŸ¥å”¯ä¸€çº¦æŸå¤±è´¥
                if (InStr(ErrorMsg, "UNIQUE constraint failed")) {
                    ; é‡æ–°è¯»å–ï¼ˆä½¿ç”¨ä¿®å¤åçš„ SQLï¼‰
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                    break ; é€€å‡º whileï¼Œé‡è¯•å¤–å±‚ Loop
                }
                break
            }
            if (Success) {
                ; æ›´æ–°æˆåŠŸï¼Œè¯´æ˜ NewSortValue å¯ç”¨
                break
            } else {
                ; æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜æœ‰å¹¶å‘ï¼Œé‡æ–°è¯»å–å½“å‰æœ€å¤§å€¼
                if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                    CurrentMax := MaxSortResult.Rows[1][1] + 0
                } else {
                    CurrentMax := 0
                }
            }
        }
        ExistingID := ""
        CheckSQL := "SELECT ID FROM " . MainTable . " WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
        CheckResult := {}
        if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
            ExistingID := CheckResult.Rows[1][1]
        }
        if (StrLen(Content) > 1000000) {
            Content := SubStr(Content, 1, 1000000)
        }
        if (StrLen(Remark) > 1000) {
            Remark := SubStr(Remark, 1, 1000)
        }
        HashValue := HashValue ? HashValue : ""
        Bytes := Bytes ? Bytes : ""
        WindowDetail := WindowTitle ? WindowTitle : ""
        Identifier := Identifier ? Identifier : ""
        Format := Format ? Format : ""
        Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        Content := Content ?RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "æœªçŸ¥åº”ç”¨"
        if (RegExMatch(WindowTitle, "(.+)\s*-\s*(.+)$", Match)) {
            AppName := Trim(Match2)
        } else {
            AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
        }
        EscapedHashValue := StrReplace(HashValue, "'", "''")
        EscapedBytes := StrReplace(Bytes, "'", "''")
        EscapedWindowDetail := StrReplace(WindowTitle, "'", "''")
        EscapedIdentifier := StrReplace(Identifier, "'", "''")
        EscapedFormat := StrReplace(Format, "'", "''")
        EscapedRemark := StrReplace(Remark, "'", "''")
        EscapedContent := StrReplace(Content, "'", "''")
        EscapedGroup := StrReplace(Group, "'", "''")
        EscapedAppName := StrReplace(AppName, "'", "''")
        EscapedClipData := StrReplace(ClipData, "'", "''")
        Success := false
        RetryCount := 3
        G_last_insert_rowid := ""
      
        if (ExistingID != "") {
            ; ğŸ”¥ ä¿®æ”¹ï¼šUPDATE è¯­å¥ä¸­ ç±»å‹ã€åˆ†ç»„ã€åº”ç”¨åç§°ã€æ ‡è¯† è®¾ä¸ºç©º
            UpdateSQL := "UPDATE " . MainTable . " SET æ’åº = " . NewSortValue . ", æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), å†…å®¹ = '" . EscapedContent . "', å­—èŠ‚ = '" . EscapedBytes . "', çª—å£è¯¦æƒ… = '" . EscapedWindowDetail . "', ç±»å‹ = '', åˆ†ç»„ = '', åº”ç”¨åç§° = '', æ ‡è¯† = '', å¤„ç†çŠ¶æ€ = NULL, æç¤ºæ—¶é—´ = NULL, æç¤º = NULL WHERE ID = " . ExistingID . ";"
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(UpdateSQL)) {
                    Success := true
                    FinalID := ExistingID
                    G_last_insert_rowid := ExistingID
                    G_last_insert_Main_ID := ExistingID
                    G_last_insert_Main_TableName := MainTable
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3720054 æ›´æ–°ä¸»è¡¨å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
            DeleteDataSQL := "DELETE FROM " . DataTable . " WHERE lParentID = " . ExistingID . ";"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(DeleteDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3724787 ; åˆ é™¤æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
            InsertDataSQL := "INSERT INTO " . DataTable . " (lParentID, strClipBoardFormat, ooData) VALUES (" . ExistingID . ", '" . EscapedFormat . "', '" . EscapedClipData . "');"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3958064 ; æ’å…¥æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
        } else {
            AllocSQL := "INSERT INTO ä¸­å¿ƒåŒ– (æ ‡è®°çŠ¶æ€) VALUES (0);"
            if (!SQLiteDB.Exec(AllocSQL)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5142862 ; åˆ†é…å…¨å±€IDå¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
          
            LastIDResult := {}
            G_last_insert_rowid := ""
            FinalID := ""
            if (SQLiteDB.GetTable("SELECT last_insert_rowid() AS newid;", LastIDResult) && LastIDResult.RowCount > 0) {
                G_last_insert_rowid := LastIDResult.Rows[1][1]
                FinalID := G_last_insert_rowid
            } else {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5224280 ;  è·å–å…¨å±€IDå¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
          
            if (FinalID = "" || FinalID <= 0) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5234045 ;  å…¨å±€IDæ— æ•ˆ: FinalID = %FinalID%
                LoadData()
                Return
            }
          
            ; ğŸ”¥ ä¿®æ”¹ï¼šINSERT è¯­å¥ä¸­ ç±»å‹ã€åˆ†ç»„ã€åº”ç”¨åç§°ã€æ ‡è¯† è®¾ä¸ºç©ºå­—ç¬¦ä¸²
            InsertMainSQL := "INSERT INTO " . MainTable . " (ID, å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, ç±»å‹, æ’åº, æ›´æ–°æ¬¡æ•°, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, åˆ†ç»„, åº”ç”¨åç§°, æ ‡è¯†, å¤„ç†çŠ¶æ€, æç¤ºæ—¶é—´, æç¤º) VALUES (" . FinalID . ", '" . EscapedHashValue . "', '" . EscapedBytes . "', '" . EscapedWindowDetail . "', '', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '', '', '', NULL, NULL, NULL);"
          
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertMainSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "UNIQUE constraint failed: " . MainTable . ".æ’åº")) {
                    ; æ’åºå€¼å†²çªï¼Œé‡æ–°è·å–
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                    NewSortValue := CurrentMax + 1
                    InsertMainSQL := RegExReplace(InsertMainSQL, "æ’åº = \d+", "æ’åº = " . NewSortValue)
                    Sleep, 50
                    RetryCount--
                    continue
                }
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                ; MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1333744 æ’å…¥ä¸»è¡¨å¤±è´¥: %ErrorMsg%`n`nSQL: %InsertMainSQL%
				GetGlobalMaxSortValue()
				ClipboardChanged(type)
                ; LoadData()
                Return
            }
          
            MarkSQL := "UPDATE ä¸­å¿ƒåŒ– SET æ ‡è®°çŠ¶æ€ = 1 WHERE Local_ID = " . FinalID . ";"
            if (!SQLiteDB.Exec(MarkSQL)) {
            }
          
            InsertDataSQL := "INSERT INTO " . DataTable . " (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", '" . EscapedFormat . "', '" . EscapedClipData . "');"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4653894 æ’å…¥æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
            G_last_insert_Main_ID := FinalID
            G_last_insert_Main_TableName := MainTable
        }
        
        ; ğŸ”¥ å±æ€§æ’å…¥éƒ¨åˆ† - å¼€å§‹ï¼ˆå°† ç±»å‹ã€åˆ†ç»„ã€åº”ç”¨åç§°ã€æ ‡è¯† æ’å…¥åˆ°å…³è”å±æ€§è¡¨ï¼‰ - å·²ä¿®å¤æ–‡ä»¶åæå–ä¸ AppName è¿‡æ»¤
        Attributes := []
        Attributes.Push({Format: "æ˜Ÿçº§", Value: "0"})
        
        ; ğŸ”¥ é‡æ„ï¼šç»Ÿä¸€å¤„ç†æ–‡ä»¶ã€å¤šæ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„åç§°ä¸å…³é”®å­—æå–
        if (InStr(Format, "CF_HDROP")) {
            if (isFolderMode) {
                ; --- æ–‡ä»¶å¤¹æ¨¡å¼ ---
                FolderFullPath := Remark ; Remark å˜é‡åœ¨æ–‡ä»¶å¤¹æ¨¡å¼ä¸‹å­˜å‚¨äº†å½“å‰å¤„ç†çš„æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„
                if (FolderFullPath != "" && InStr(FileExist(FolderFullPath), "D")) {
                    SplitPath, FolderFullPath, FolderName
                    
                    ; 1. æ·»åŠ æ–‡ä»¶å¤¹æœ¬èº«çš„åç§°ä½œä¸º "æ–‡ä»¶åç§°" å’Œ "å…³é”®å­—"
                    if (FolderName != "") {
                        Attributes.Push({Format: "æ–‡ä»¶åç§°", Value: FolderName})
                        Attributes.Push({Format: "å…³é”®å­—", Value: FolderName})
                    }

                    ; 2. éå†æ‰€æœ‰å­æ–‡ä»¶ï¼Œæ·»åŠ æ— æ‰©å±•åçš„æ–‡ä»¶åä½œä¸ºå…³é”®å­—
                    Loop, Files, %FolderFullPath%\\*.*, F
                    {
                        SplitPath, A_LoopFileName, , , , FileNameNoExt
                        if (FileNameNoExt != "" && FileNameNoExt != A_LoopFileName) {
                            Attributes.Push({Format: "å…³é”®å­—", Value: FileNameNoExt})
                        }
                    }
                }
            } else {
                ; --- æ–‡ä»¶æ¨¡å¼ï¼ˆå•ä¸ªæˆ–å¤šä¸ªï¼‰---
                if (AllPaths.MaxIndex() > 0) {
                    Loop, % AllPaths.MaxIndex() {
                        CurrentPath := AllPaths[A_Index]
                        SplitPath, CurrentPath, FileName, , , FileNameNoExt
                        
                        if (FileName != "") {
                            Attributes.Push({Format: "æ–‡ä»¶åç§°", Value: FileName})
                        }
                        if (FileNameNoExt != "") {
                            Attributes.Push({Format: "å…³é”®å­—", Value: FileNameNoExt})
                        }
                    }
                }
            }
        } else {
             ; --- é CF_HDROP ä½†å¯èƒ½æ˜¯è·¯å¾„æ–‡æœ¬çš„æƒ…å†µ ---
            ExtractedFileName := ""
            ExtractedNameNoExt := ""
            if (Remark != "") {
                FirstPath := Remark
                if (InStr(Remark, "`n")) {
                    tmp := StrSplit(Remark, "`n")
                    FirstPath := Trim(tmp[1])
                } else if (InStr(Remark, "`r")) {
                    tmp := StrSplit(Remark, "`r")
                    FirstPath := Trim(tmp[1])
                } else {
                    FirstPath := Trim(Remark)
                }
                
                if (InStr(FirstPath, "\\") || InStr(FirstPath, "/")) {
                    SplitPath, FirstPath, TmpFileName, , , TmpFileNameNoExt
                    ExtractedFileName := TmpFileName
                    ExtractedNameNoExt := TmpFileNameNoExt
                } else {
                    ExtractedFileName := FirstPath
                    if RegExMatch(FirstPath, "^(.*)\\.([^.]+)$", m) {
                        ExtractedNameNoExt := m1
                    } else {
                        ExtractedNameNoExt := FirstPath
                    }
                }
            }
            if (ExtractedFileName != "") {
                Attributes.Push({Format: "æ–‡ä»¶åç§°", Value: ExtractedFileName})
                if (ExtractedNameNoExt != "") {
                    Attributes.Push({Format: "å…³é”®å­—", Value: ExtractedNameNoExt})
                } else {
                    Attributes.Push({Format: "å…³é”®å­—", Value: ExtractedFileName})
                }
            }
        }
        
        ; å°†ç±»å‹å­—æ®µæ‹†åˆ†åæ’å…¥åˆ°å…³è”å±æ€§è¡¨
        if (Format != "") {
            ; æ‹†åˆ†æ ¼å¼å­—ç¬¦ä¸²ï¼ˆå¦‚ "CF_HDROP,ğŸ“,exe" -> ["CF_HDROP", "ğŸ“", "exe"]ï¼‰
            FormatParts := StrSplit(Format, ",")
            Loop, % FormatParts.Length() {
                TypeValue := Trim(FormatParts[A_Index])
                if (TypeValue != "" && TypeValue != "CF_HDROP" && TypeValue != "CF_UNICODETEXT") {
                    ; è¿‡æ»¤æ‰ç³»ç»Ÿæ ¼å¼æ ‡è¯†ï¼Œåªä¿ç•™æœ‰æ„ä¹‰çš„ç±»å‹
                    Attributes.Push({Format: "ç±»å‹", Value: TypeValue})
                }
            }
        }
        
        ; å°†æ ‡è¯†ç¬¦ä¹Ÿæ’å…¥åˆ°å…³è”å±æ€§è¡¨
        if (Identifier != "") {
            IdentifierParts := StrSplit(Identifier, ",")
            Loop, % IdentifierParts.Length() {
                IDValue := Trim(IdentifierParts[A_Index])
                if (IDValue != "") {
                    Attributes.Push({Format: "æ ‡è¯†", Value: IDValue})
                }
            }
        }
        
        ; å¦‚æœæ˜¯ç½‘å€ï¼Œæ·»åŠ ç‰¹å®šå…³é”®å­—
        if (Identifier = "ğŸ”—") {
            Attributes.Push({Format: "å…³é”®å­—", Value: "ç½‘å€"})
            Attributes.Push({Format: "å…³é”®å­—", Value: "é“¾æ¥"})
            Attributes.Push({Format: "å…³é”®å­—", Value: "ç½‘ç«™"})
        }
        
        if (DataType = 1 && ClipData != "") {
            if (InStr(ClipData, ";") || InStr(ClipData, "{") || InStr(ClipData, "}") || InStr(ClipData, "function") || InStr(ClipData, "def ") || InStr(ClipData, "#include") || InStr(ClipData, "public ") || InStr(ClipData, "private ") || InStr(ClipData, "class ") || InStr(ClipData, "var ") || InStr(ClipData, "let ") || InStr(ClipData, "const ") || InStr(ClipData, "if (") || InStr(ClipData, "else") || InStr(ClipData, "for (") || InStr(ClipData, "while (")) {
                Attributes.Push({Format: "å…³é”®å­—", Value: "ä»£ç "})
            }
        }
        
        ; å°†åˆ†ç»„æ’å…¥åˆ°å…³è”å±æ€§è¡¨
        if (Group != "") {
            Attributes.Push({Format: "åˆ†ç»„", Value: Group})
        }
        
        ; å°†åº”ç”¨åç§°æ’å…¥åˆ°å…³è”å±æ€§è¡¨ï¼ˆä½†é¿å…æŠŠçŸ­ç‰ˆæœ¬å·/çŸ­æ ‡è¯†å¦‚ "V5" å½“ä½œåº”ç”¨åç§°æˆ–å…³é”®å­—ï¼‰
        if (AppName != "" && AppName != "æœªçŸ¥åº”ç”¨") {
            ; ä»…å½“ AppName ä¸æ˜¯çŸ­çš„ç‰ˆæœ¬å·/çŸ­æ ‡è¯†æ—¶ï¼Œæ‰æ’å…¥ä¸º â€œåº”ç”¨åç§°â€
            if !(RegExMatch(AppName, "^(v|V)?\\d+(\\.\\d+)*$") || StrLen(AppName) <= 3) {
                Attributes.Push({Format: "åº”ç”¨åç§°", Value: AppName})
            }
            IsFolderPath := (RegExMatch(AppName, "^[A-Za-z]:\\\\.*$") && InStr(FileExist(AppName), "D"))
            if (IsFolderPath) {
                SplitPath, AppName, FolderName
                if (FolderName != "") {
                    Attributes.Push({Format: "å…³é”®å­—", Value: FolderName})
                }
            } else {
                Tags := []
                if (RegExMatch(AppName, "^(.+)\\s*-\\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    ; è¿‡æ»¤æ‰åƒ V5ã€v1.2ã€1.0 ç­‰ç‰ˆæœ¬å·/çŸ­æ ‡è¯† (é•¿åº¦<=3 æˆ– çº¯æ•°å­—/ç‰ˆæœ¬å·æ ¼å¼)
                    if !(RegExMatch(SecondPart, "^(v|V)?\\d+(\\.\\d+)*$") || StrLen(SecondPart) <= 3) {
                        if (!RegExMatch(FirstPart, "\\.[a-zA-Z0-9]{1,4}$")) {
                            Tags.Push(FirstPart)
                        }
                        if (SecondPart = "Google Chrome") {
                            Tags.Push("Chrome")
                        } else {
                            Tags.Push(SecondPart)
                        }
                    } else {
                        ; è‹¥ç¬¬äºŒéƒ¨åˆ†è¢«è®¤ä¸ºæ˜¯ç‰ˆæœ¬å·/çŸ­æ ‡è¯†ï¼Œåˆ™åªä½¿ç”¨ç¬¬ä¸€éƒ¨åˆ†ï¼ˆå¦‚æœåˆç†ï¼‰
                        if (!RegExMatch(FirstPart, "\\.[a-zA-Z0-9]{1,4}$")) {
                            Tags.Push(FirstPart)
                        }
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        ; ä»…å½“ AppName è‡ªèº«ä¸æ˜¯çŸ­ç‰ˆæ ‡è¯†æ—¶æ‰ä½œä¸ºå…³é”®å­—
                        if !(RegExMatch(AppName, "^(v|V)?\\d+(\\.\\d+)*$") || StrLen(AppName) <= 3) {
                            Tags.Push(AppName)
                        }
                    }
                }
                for index, Tag in Tags {
                    if (Tag != "" && Tag != "æœªçŸ¥åº”ç”¨") {
                        Attributes.Push({Format: "å…³é”®å­—", Value: Tag})
                    }
                }
            }
        }
        
        for index, attr in Attributes {
            Result := InsertAttribute(MainTable, FinalID, attr.Format, attr.Value)
            ErrorMsg := Result.ErrorMsg
            if (!Result.Success && ErrorMsg != "æ˜Ÿçº§ä¸º 0ï¼Œè·³è¿‡æ’å…¥" && ErrorMsg != "å±æ€§æ ¼å¼æˆ–å€¼ä¸ºç©ºï¼Œè·³è¿‡") {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š2125567 æ’å…¥å±æ€§å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
        }
        ; ğŸ”¥ å±æ€§æ’å…¥éƒ¨åˆ† - ç»“æŸ
        
        return
      
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("ClipboardChanged")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4846379 ClipboardChanged å¼‚å¸¸: %eMessage%
    } finally {
        G_last_insert_rowid := FinalID
        g_CurrentRecord.ID := FinalID
        g_CurrentRecord.TableName := MainTable
        SB_SetText("ClipboardChanged: å¡«å……ç¼“å­˜ ID=" . FinalID)
        ProcessingContext := ""
        if (ClipboardLock = 3) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        LoadData()
		GetGlobalMaxSortValue()
    }
    Return
}

GetFileTypeSymbol(filePath, fileExt) {
    if (InStr(FileExist(filePath), "D")) {
        Return "ğŸ“"
    }
    lossyMusicExts := "mp3,aac,m4a,ogg"
    losslessMusicExts := "flac,alac,ape"
    uncompressedMusicExts := "wav,aiff"
    specialMusicExts := "dsf,dff,mid"
    videoExts := "mp4,avi,mkv,wmv,flv,mov"
    imageExts := "jpg,jpeg,png,gif,bmp,tiff"
    docExts := "doc,docx,pdf,txt,rtf"
    if (InStr(lossyMusicExts, fileExt))
        Return "ğŸ§,â™«"
    else if (InStr(losslessMusicExts, fileExt) || (fileExt = "m4a" && InStr(filePath, "ALAC")))
        Return "ğŸ¼,â™«"
    else if (InStr(uncompressedMusicExts, fileExt))
        Return "ğŸ“€,â™«"
    else if (InStr(specialMusicExts, fileExt))
        Return "ğŸ¶,â™«"
    else if (InStr(videoExts, fileExt))
        Return "ğŸ¥"
    else if (InStr(imageExts, fileExt))
        Return "ğŸ–¼ï¸"
    else if (InStr(docExts, fileExt))
        Return "ğŸ“"
    else
        Return "ğŸ“"
}

InsertAttribute(TableName, DataID, AttrFormat, AttrValue, DataFormat := "") {
    Global SQLiteDB, DBPath
    Result := {}
    Result.Success := 0
    Result.ErrorMsg := ""
    Result.AttrID := ""

    ; AddDebugLog("InsertAttribute å¼€å§‹, TableName=" . TableName . ", DataID=" . DataID . ", AttrFormat=" . AttrFormat . ", AttrValue=" . AttrValue . ", DataFormat=" . DataFormat)

    if (!SQLiteDB) {
        Result.ErrorMsg := "ERROR_202547: SQLiteDB æœªåˆå§‹åŒ–"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    if (!CheckDBUnlocked(DBPath)) {
        Result.ErrorMsg := "4351898: æ•°æ®åº“è¢«é”å®š"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    ; éªŒè¯è¡¨ååˆæ³•æ€§ï¼ˆé˜²æ­¢SQLæ³¨å…¥ï¼‰
    if (TableName = "" || RegExMatch(TableName, "[;'\[\]]")) {
        Result.ErrorMsg := "ERROR_202552: è¡¨åéæ³•: " . TableName
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    ; éªŒè¯ä¸»è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆæ³¨å†Œç™»è®°ä¸»è¡¨ï¼‰
    EscapedTableName := StrReplace(TableName, "'", "''")
    CheckMainTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . EscapedTableName . "';"
    MainTableResult := {}
    if (!SQLiteDB.GetTable(CheckMainTableSQL, MainTableResult) || MainTableResult.RowCount = 0) {
        Result.ErrorMsg := "ERROR_202553: ä¸»è¡¨ " . TableName . " ä¸å­˜åœ¨"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    ; éªŒè¯IDæ˜¯å¦å­˜åœ¨äºä¸»è¡¨ä¸­
    CheckDataIDSQL := "SELECT ID FROM [" . EscapedTableName . "] WHERE ID = " . DataID . " LIMIT 1;"
    DataIDResult := {}
    if (!SQLiteDB.GetTable(CheckDataIDSQL, DataIDResult) || DataIDResult.RowCount = 0) {
        Result.ErrorMsg := "ERROR_6247458: ID " . DataID . " åœ¨è¡¨ " . TableName . " ä¸­ä¸å­˜åœ¨"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    PropTableName := TableName . "_å…³è”å±æ€§"

    ; æ£€æŸ¥å…³è”å±æ€§è¡¨æ˜¯å¦å­˜åœ¨
    CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTableName . "';"
    PropTableResult := {}
    if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
        Result.ErrorMsg := "ERROR_5354041: å±æ€§å…³è”è¡¨ " . PropTableName . " ä¸å­˜åœ¨"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }
    ; AddDebugLog("å±æ€§å…³è”è¡¨æ£€æŸ¥é€šè¿‡: " . PropTableName)

    AttrFormat := Trim(AttrFormat)
    AttrValue := Trim(AttrValue)

    if (AttrFormat = "" || AttrValue = "") {
        Result.Success := 1
        Result.ErrorMsg := "å±æ€§æ ¼å¼æˆ–å€¼ä¸ºç©ºï¼Œè·³è¿‡"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    if (StrLen(AttrValue) > 1000) {
        AttrValue := SubStr(AttrValue, 1, 1000)
    }

    if (AttrFormat = "æ˜Ÿçº§" && AttrValue = "0") {
        Result.Success := 1
        Result.ErrorMsg := "æ˜Ÿçº§ä¸º 0ï¼Œè·³è¿‡æ’å…¥"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    EscapedAttrFormat := StrReplace(AttrFormat, "'", "''")
    EscapedAttrValue := StrReplace(AttrValue, "'", "''")
    EscapedDataFormat := StrReplace(DataFormat, "'", "''")
    
    ; æ£€æŸ¥å±æ€§æ˜¯å¦å·²å­˜åœ¨ï¼ˆåœ¨å…¨å±€å…³è”å±æ€§è¡¨ä¸­ï¼‰
    GetAttrIDSQL := "SELECT Local_ID, ID FROM å…³è”å±æ€§è¡¨ WHERE å±æ€§ç±»å‹ = '" . EscapedAttrFormat . "' AND å±æ€§å€¼ = '" . EscapedAttrValue . "' LIMIT 1;"
    AttrResult := {}
    AttrID := ""
    
    SQLiteDB.Exec("PRAGMA busy_timeout = 5000;")

    if (SQLiteDB.GetTable(GetAttrIDSQL, AttrResult) && AttrResult.RowCount > 0) {
        AttrID := AttrResult.Rows[1][2]  ; è·å– ID å­—æ®µï¼ˆTEXTï¼‰
        ; AddDebugLog("æ‰¾åˆ°ç°æœ‰å±æ€§ ID: " . AttrID)
    } else {
        ; AddDebugLog("æœªæ‰¾åˆ°ç°æœ‰å±æ€§, å‡†å¤‡æ’å…¥æ–°å±æ€§")
        ; æ’å…¥æ—¶åŒ…å«æ ¼å¼å­—æ®µ
        if (DataFormat != "") {
            InsertAttrSQL := "INSERT OR IGNORE INTO å…³è”å±æ€§è¡¨ (å±æ€§ç±»å‹, å±æ€§å€¼, ç±»å‹) VALUES ('" . EscapedAttrFormat . "', '" . EscapedAttrValue . "', '" . EscapedDataFormat . "');"
        } else {
            InsertAttrSQL := "INSERT OR IGNORE INTO å…³è”å±æ€§è¡¨ (å±æ€§ç±»å‹, å±æ€§å€¼) VALUES ('" . EscapedAttrFormat . "', '" . EscapedAttrValue . "');"
        }
        
        RetryCount := 5
        Success := false
        while (RetryCount > 0) {
            if (SQLiteDB.Exec(InsertAttrSQL)) {
                Success := true
                ; AddDebugLog("æ’å…¥å…³è”å±æ€§è¡¨æˆåŠŸ")
                break
            }
            ErrorMsg := SQLiteDB._ErrMsg()
            ; AddDebugLog("æ’å…¥å…³è”å±æ€§è¡¨å¤±è´¥ (é‡è¯• " . (6-RetryCount) . "): " . ErrorMsg)
            if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                Sleep, 200
                RetryCount--
                continue
            }
            Result.ErrorMsg := "ERROR_202548: æ’å…¥å…³è”å±æ€§è¡¨å¤±è´¥: " . ErrorMsg
            Return Result
        }
        
        if (!Success) {
            Result.ErrorMsg := "ERROR_202548: æ’å…¥å…³è”å±æ€§è¡¨å¤±è´¥ï¼Œè¶…è¿‡é‡è¯•æ¬¡æ•°"
            ; AddDebugLog(Result.ErrorMsg)
            Return Result
        }
        
        ; è·å–æ–°æ’å…¥çš„ Local_ID å’Œ ID
        GetAttrIDSQL := "SELECT Local_ID, ID FROM å…³è”å±æ€§è¡¨ WHERE å±æ€§ç±»å‹ = '" . EscapedAttrFormat . "' AND å±æ€§å€¼ = '" . EscapedAttrValue . "' LIMIT 1;"
        RetryCount := 5
        while (RetryCount > 0) {
            if (SQLiteDB.GetTable(GetAttrIDSQL, AttrResult) && AttrResult.RowCount > 0) {
                AttrID := AttrResult.Rows[1][2]  ; è·å– ID å­—æ®µ
                if (AttrID = "") {
                    AttrID := AttrResult.Rows[1][1]  ; å¦‚æœ ID ä¸ºç©ºï¼Œ fallback åˆ° Local_ID
                    ; æ›´æ–° ID å­—æ®µä¸º Local_ID çš„æ–‡æœ¬å½¢å¼
                    UpdateIDSQL := "UPDATE å…³è”å±æ€§è¡¨ SET ID = '" . AttrID . "' WHERE Local_ID = " . AttrResult.Rows[1][1] . ";"
                    if (!SQLiteDB.Exec(UpdateIDSQL)) {
                        ErrorMsg := SQLiteDB._ErrMsg()
                        Result.ErrorMsg := "ERROR_202549: æ›´æ–°å±æ€§ ID å¤±è´¥: " . ErrorMsg
                        ; AddDebugLog(Result.ErrorMsg)
                        Return Result
                    }
                    ; AddDebugLog("æ›´æ–°å±æ€§ ID æˆåŠŸ: " . AttrID)
                }
                ; AddDebugLog("è·å–æ–°å±æ€§ ID: " . AttrID)
                break
            }
            Sleep, 100
            RetryCount--
        }
        
        if (AttrID = "") {
            Result.ErrorMsg := "ERROR_202549: æ’å…¥åæœªæ‰¾åˆ°å±æ€§ IDï¼Œå±æ€§ç±»å‹='" . AttrFormat . "', å±æ€§å€¼='" . AttrValue . "'"
            ; AddDebugLog(Result.ErrorMsg)
            Return Result
        }
    }

    if (AttrID = "") {
        Result.ErrorMsg := "ERROR_202549: æ— æ•ˆçš„å±æ€§ ID"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    ; æ£€æŸ¥å±æ€§å…³è”æ˜¯å¦å·²å­˜åœ¨ï¼ˆåŠ¨æ€PropTableNameï¼‰
    EscapedPropTable := StrReplace(PropTableName, "'", "''")
    CheckExistSQL := "SELECT COUNT(*) FROM [" . EscapedPropTable . "] WHERE å±æ€§ID = '" . StrReplace(AttrID, "'", "''") . "' AND ID = " . DataID . ";"
    CheckResult := {}
    ExistingCount := 0
    
    if (SQLiteDB.GetTable(CheckExistSQL, CheckResult) && CheckResult.RowCount > 0) {
        ExistingCount := CheckResult.Rows[1][1]
        if (ExistingCount > 0) {
            Result.Success := 1
            Result.ErrorMsg := "å±æ€§å…³è”å·²å­˜åœ¨"
            Result.AttrID := AttrID
            ; AddDebugLog("å±æ€§å…³è”å·²å­˜åœ¨")
            Return Result
        }
    } else {
        ErrorMsg := SQLiteDB._ErrMsg()
        Result.ErrorMsg := "ERROR_3744312: æ£€æŸ¥å±æ€§å…³è”å¤±è´¥: " . ErrorMsg
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }
    ; AddDebugLog("å±æ€§å…³è”ä¸å­˜åœ¨, å‡†å¤‡æ’å…¥")

    ; æ’å…¥å±æ€§å…³è”æ—¶ä¹ŸåŒ…å«æ ¼å¼å­—æ®µ
    if (DataFormat != "") {
        InsertAssocSQL := "INSERT INTO [" . EscapedPropTable . "] (å±æ€§ID, ID, æ ¼å¼) VALUES ('" . StrReplace(AttrID, "'", "''") . "', " . DataID . ", '" . EscapedDataFormat . "');"
    } else {
        InsertAssocSQL := "INSERT INTO [" . EscapedPropTable . "] (å±æ€§ID, ID) VALUES ('" . StrReplace(AttrID, "'", "''") . "', " . DataID . ");"
    }
    
    RetryCount := 5
    Success := false
    while (RetryCount > 0) {
        if (SQLiteDB.Exec(InsertAssocSQL)) {
            Success := true
            ; AddDebugLog("æ’å…¥å±æ€§å…³è”æˆåŠŸ")
            break
        }
        ErrorMsg := SQLiteDB._ErrMsg()
        ; AddDebugLog("æ’å…¥å±æ€§å…³è”å¤±è´¥ (é‡è¯• " . (6-RetryCount) . "): " . ErrorMsg)
        if (InStr(ErrorMsg, "SQLITE_BUSY")) {
            Sleep, 200
            RetryCount--
            continue
        }
        Result.ErrorMsg := "2716957: æ’å…¥å±æ€§å…³è”å¤±è´¥: " . ErrorMsg
        Return Result
    }
    
    if (!Success) {
        Result.ErrorMsg := "2720504: æ’å…¥å±æ€§å…³è”å¤±è´¥ï¼Œè¶…è¿‡é‡è¯•æ¬¡æ•°"
        ; AddDebugLog(Result.ErrorMsg)
        Return Result
    }

    Result.Success := 1
    Result.ErrorMsg := ""
    Result.AttrID := AttrID
    ; AddDebugLog("InsertAttribute å®ŒæˆæˆåŠŸ, TableName=" . TableName . ", AttrID=" . AttrID)
    Return Result
}

VerifyAllAttributes(DataID, TableName) {
    Global SQLiteDB
    
    AttrCount := 0
    
    ; æ£€æŸ¥ä¸»è¡¨æ˜¯å¦å­˜åœ¨
    EscapedTableName := StrReplace(TableName, "'", "''")
    CheckMainTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . EscapedTableName . "';"
    MainTableResult := {}
    if (!SQLiteDB.GetTable(CheckMainTableSQL, MainTableResult) || MainTableResult.RowCount = 0) {
        MsgBox, 16, é”™è¯¯, VerifyAllAttributes: ä¸»è¡¨ " . TableName . " ä¸å­˜åœ¨
        Return -1
    }
    
    ; æ£€æŸ¥ DataID æ˜¯å¦å­˜åœ¨
    CheckDataIDSQL := "SELECT ID FROM [" . EscapedTableName . "] WHERE ID = " . DataID . " LIMIT 1;"
    DataIDResult := {}
    if (!SQLiteDB.GetTable(CheckDataIDSQL, DataIDResult) || DataIDResult.RowCount = 0) {
        MsgBox, 16, é”™è¯¯, VerifyAllAttributes: ID " . DataID . " åœ¨è¡¨ " . TableName . " ä¸­ä¸å­˜åœ¨
        Return -1
    }
    
    ; æ£€æŸ¥å±æ€§å…³è”è¡¨æ˜¯å¦å­˜åœ¨
    PropTableName := TableName . "_å…³è”å±æ€§"
    CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTableName . "';"
    PropTableResult := {}
    if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
        MsgBox, 16, é”™è¯¯, VerifyAllAttributes: å±æ€§å…³è”è¡¨ " . PropTableName . " ä¸å­˜åœ¨
        Return -1
    }
    
    Return AttrCount
}


ClipboardChangedTip() {
    CoordMode, Tooltip, Windows
    MouseGetPos, x, y

    message := "å·²æˆåŠŸåˆ›å»ºæ•°æ®ï¼"

    Loop, 2 {
        Tooltip, %message%, x0, y-50
        Sleep, 100
        Tooltip
    }
    Tooltip, %message%, x0, y-50
    Sleep, 1500
    Tooltip
}

BeginSafeTransaction(context) {
    Global SQLiteDB, TransactionActive, TransactionOwner
    if (TransactionActive) {
        ; AddDebugLog("äº‹åŠ¡å·²æ´»è·ƒï¼Œä¸Šä¸‹æ–‡: " . TransactionOwner . "ï¼Œè·³è¿‡ BEGIN")
        Return true  ; å…è®¸åµŒå¥—ï¼Œä½†ä¸é¢å¤– BEGINï¼ˆSQLite ç”¨ SAVEPOINTï¼‰
    }
    ; AddDebugLog("æ‰§è¡Œ BEGIN TRANSACTION")
    if (!SQLiteDB.Exec("BEGIN TRANSACTION;")) {
        ErrorMsg := SQLiteDB._ErrMsg()
        ; AddDebugLog("BEGIN æ‰§è¡Œå¤±è´¥: " . ErrorMsg)
        Return false
    }
    TransactionActive := true
    TransactionOwner := context
    ; AddDebugLog("äº‹åŠ¡å¼€å§‹æˆåŠŸï¼ŒOwner: " . context)
    Return true
}

CommitSafeTransaction(context) {
    Global SQLiteDB, TransactionActive, TransactionOwner
    if (!TransactionActive) {
        ; AddDebugLog("æ— æ´»è·ƒäº‹åŠ¡ï¼Œæ— æ³• COMMIT")
        Return false
    }
    if (TransactionOwner != context) {
        ; AddDebugLog("ä¸Šä¸‹æ–‡ä¸åŒ¹é…: å½“å‰ " . TransactionOwner . "ï¼Œé¢„æœŸ " . context)
        Return false
    }
    ; AddDebugLog("æ‰§è¡Œ COMMIT")
    if (!SQLiteDB.Exec("COMMIT;")) {
        ErrorMsg := SQLiteDB._ErrMsg()
        ; AddDebugLog("COMMIT æ‰§è¡Œå¤±è´¥: " . ErrorMsg)
        Return false
    }
    TransactionActive := false
    TransactionOwner := ""
    ; AddDebugLog("äº‹åŠ¡æäº¤æˆåŠŸ")
    Return true
}

RollbackSafeTransaction(context) {
    Global SQLiteDB, TransactionActive, TransactionOwner
    if (!TransactionActive) {
        ; AddDebugLog("æ— æ´»è·ƒäº‹åŠ¡ï¼Œè·³è¿‡ ROLLBACK")
    } else if (TransactionOwner != context) {
        ; AddDebugLog("ä¸Šä¸‹æ–‡ä¸åŒ¹é…ï¼Œè·³è¿‡ ROLLBACK")
    } else {
        ; AddDebugLog("æ‰§è¡Œ ROLLBACK")
        SQLiteDB.Exec("ROLLBACK;")
    }
    TransactionActive := false
    TransactionOwner := ""
    ; AddDebugLog("äº‹åŠ¡å›æ»šå®Œæˆï¼Œé‡ç½®æ ‡å¿—")
    Return true
}

;===================|===================

; äºŒ æ–°ç‰ˆæœ¬
; 1. ä¸»å‡½æ•°
ClipboardChanged(type) {
    Global SQLiteDB, DBPath, IsCopying, ClipboardLock, ProcessingContext, TransactionActive, TransactionOwner
    Global G_last_insert_rowid, G_last_insert_Main_ID, G_last_insert_Main_TableName, g_CurrentRecord
    
    ; ğŸ”’ æ£€æŸ¥é”å®šçŠ¶æ€
    if (ClipboardLock != 0) {
        Return
    }
  
    ; ğŸªŸ è·å–çª—å£ä¿¡æ¯
    WinGet, ActiveID, ID, A
    WinGetTitle, WindowTitle, ahk_id %ActiveID%
    if (InStr(WindowTitle, "å°è±¡è®°å¿†_5")) {
        Return
    }
    if (type != 1 && type != 2) {
        Return
    }
    
    ; ğŸ” è®¾ç½®é”å®š
    ClipboardLock := 3
    ProcessingContext := "Clipboard"
    FinalID := ""
    MainTable := ""
    
    try {
        ; ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“
        if (!InitDB(DBPath)) {
            LoadData()
            Return
        }
        
        ; âœ… æµ‹è¯•æ•°æ®åº“æ˜¯å¦å¯å†™
        TestWriteSQL := "CREATE TEMP TABLE IF NOT EXISTS _test_write (id INTEGER); DROP TABLE IF EXISTS _test_write;"
        if (!SQLiteDB.Exec(TestWriteSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4103698 æ•°æ®åº“è¢«å ç”¨æˆ–æ— å†™å…¥æƒé™`n`né”™è¯¯: %ErrorMsg%`nè·¯å¾„: %DBPath%
            LoadData()
            Return
        }
        
        ; ğŸ¯ æ ¹æ®å‰ªè´´æ¿å†…å®¹åŠ¨æ€å†³å®šä¸»è¡¨åç§°
        isFileSystemContent := false
        if (DllCall("IsClipboardFormatAvailable", "UInt", 15)) { ; CF_HDROP
            isFileSystemContent := true
        } else {
            TempClipData := Clipboard
            TempClipData := Trim(RegExReplace(TempClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", ""))
            if (TempClipData != "") {
                lines := StrSplit(TempClipData, "`n")
                FirstLine := Trim(lines[1])
                if (RegExMatch(FirstLine, "^[A-Za-z]:\\.*$") || RegExMatch(FirstLine, "^\\\\.*$")) {
                    isFileSystemContent := true
                }
            }
        }

        if (isFileSystemContent) {
            MainTable := "Database"
        } else {
            MainTable := "å†å²æ•°æ®"
        }
        
        DataTable := "Data_" . MainTable
        
        ; ğŸ”§ éªŒè¯å’Œæ¢å¤è¡¨ç»“æ„
        if (!ValidateAndRestoreTables(MainTable, DataTable)) {
            LoadData()
            Return
        }
        
        ; âœ”ï¸ éªŒè¯å¿…éœ€å­—æ®µ
        if (!ValidateTableFields(MainTable)) {
            LoadData()
            Return
        }
        
        Sleep, 100
        
        ; ğŸš€ å¼€å§‹äº‹åŠ¡
        if (!BeginSafeTransaction("ClipboardChanged")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1938940 å¼€å§‹äº‹åŠ¡å¤±è´¥ï¼
            LoadData()
            Return
        }
        
        ; ğŸ“‹ å¤„ç†å‰ªè´´æ¿å†…å®¹ï¼ˆè°ƒåº¦åˆ°å¯¹åº”å¤„ç†å‡½æ•°ï¼‰
        if (DllCall("IsClipboardFormatAvailable", "UInt", 15)) {
            ; CF_HDROP - æ–‡ä»¶/æ–‡ä»¶å¤¹
            FinalID := ProcessFileClipboard(MainTable, DataTable, WindowTitle)
        } else {
            ; CF_UNICODETEXT - æ–‡æœ¬
            FinalID := ProcessTextClipboard(MainTable, DataTable, WindowTitle)
        }
        
        ; âŒ æ£€æŸ¥å¤„ç†ç»“æœ
        if (FinalID = "" || FinalID <= 0) {
            RollbackSafeTransaction("ClipboardChanged")
            LoadData()
            Return
        }
        
        ; ğŸ’¾ æ›´æ–°æœ€åæ’å…¥IDè®°å½•
        UpdateLastInsertID(FinalID)
        
        ; âœ… æäº¤äº‹åŠ¡
        if (!CommitSafeTransaction("ClipboardChanged")) {
            RollbackSafeTransaction("ClipboardChanged")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3828190 äº‹åŠ¡æäº¤å¤±è´¥ï¼
            LoadData()
            Return
        }
        
        ; ğŸ” éªŒè¯å±æ€§å…³è”
        AttrCount := VerifyAllAttributes(FinalID, MainTable)
        if (AttrCount < 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5020111 å±æ€§å…³è”éªŒè¯å¤±è´¥
        }
        
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("ClipboardChanged")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4846379 ClipboardChanged å¼‚å¸¸: %eMessage%
    } finally {
        ; ğŸ”„ æ›´æ–°å…¨å±€å˜é‡
        G_last_insert_rowid := FinalID
        g_CurrentRecord.ID := FinalID
        g_CurrentRecord.TableName := MainTable
        SB_SetText("ClipboardChanged: å¡«å……ç¼“å­˜ ID=" . FinalID)
        
        ; ğŸ”“ è§£é”
        ProcessingContext := ""
        if (ClipboardLock = 3) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        
        ; ğŸ”„ åˆ·æ–°ç•Œé¢
        LoadData()
        GetGlobalMaxSortValue()
    }
    Return
}

; 2.1 ä¸»è°ƒåº¦å‡½æ•° - ProcessFileClipboard()
ProcessFileClipboard(MainTable, DataTable, WindowTitle) {
    ; ğŸ“‹ è§£æå‰ªè´´æ¿ä¸­çš„æ‰€æœ‰æ–‡ä»¶è·¯å¾„
    ClipData := Clipboard
    AllPaths := []
    FileCount := 0
    
    Loop, Parse, Clipboard, `n, `r
    {
        Path := Trim(A_LoopField)
        if (Path != "" && FileExist(Path)) {
            AllPaths.Push(Path)
            FileCount++
        }
    }
    
    ; âŒ æ²¡æœ‰æœ‰æ•ˆè·¯å¾„
    if (FileCount = 0) {
        Return ""
    }
    
    ; ğŸ¯ åˆ¤æ–­æ˜¯æ–‡ä»¶å¤¹æ¨¡å¼è¿˜æ˜¯æ–‡ä»¶æ¨¡å¼
    Path := AllPaths[1]
    FileAttrib := FileExist(Path)
    isFolderMode := InStr(FileAttrib, "D")
    
    ; ğŸ“ è·å–åˆ†ç»„ï¼ˆçˆ¶æ–‡ä»¶å¤¹åï¼‰
    SplitPath, Path, , FileDir
    Group := ""
    if (FileDir) {
        SplitPath, FileDir, Group
    }
    
    FinalID := ""
    
    if (isFolderMode) {
        ; ğŸ“‚ æ–‡ä»¶å¤¹æ¨¡å¼ï¼šå¤„ç†æ–‡ä»¶å¤¹åŠå…¶å­é¡¹
        FinalID := ProcessFolderMode(MainTable, DataTable, AllPaths, WindowTitle)
    } else {
        ; ğŸ“„ æ–‡ä»¶æ¨¡å¼ï¼šå¤„ç†å•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶
        FinalID := ProcessFilesMode(MainTable, DataTable, AllPaths, Group, WindowTitle)
    }
    
    Return FinalID
}

; 2.2 æ–‡ä»¶å¤¹æ¨¡å¼å¤„ç† - ProcessFolderMode()
ProcessFolderMode(MainTable, DataTable, AllPaths, WindowTitle) {
    FinalID := ""
    
    ; ğŸ”„ éå†æ‰€æœ‰è·¯å¾„ï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä½†æ”¯æŒå¤šä¸ªï¼‰
    Loop, % AllPaths.Length() {
        CurrentPath := AllPaths[A_Index]
        CurrentAttrib := FileExist(CurrentPath)
        
        ; âš ï¸ è·³è¿‡éæ–‡ä»¶å¤¹
        if (!InStr(CurrentAttrib, "D")) {
            continue
        }
        
        ; ğŸ“‹ æ”¶é›†ç¬¬ä¸€å±‚å­æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
        FirstLevelFolders := []
        FirstLevelFiles := []
        
        ; æ”¶é›†å­æ–‡ä»¶å¤¹
        Loop, Files, %CurrentPath%\*.*, D
        {
            FirstLevelFolders.Push(A_LoopFileFullPath)
        }
        
        ; æ”¶é›†ç›´æ¥æ–‡ä»¶
        Loop, Files, %CurrentPath%\*.*, F
        {
            FirstLevelFiles.Push(A_LoopFileFullPath)
        }
        
        ; ğŸ“‚ ä¸ºæ¯ä¸ªå­æ–‡ä»¶å¤¹å•ç‹¬åˆ›å»ºè®°å½•
        Loop, % FirstLevelFolders.Length() {
            SubFolderPath := FirstLevelFolders[A_Index]
            
            ; æ”¶é›†å­æ–‡ä»¶å¤¹æ•°æ®
            LocalData := CollectFolderData(SubFolderPath)
            
            if (LocalData.ClipData = "") {
                continue
            }
            
            ; æ’å…¥è®°å½•
            FinalID := InsertRecord(MainTable, DataTable, LocalData, WindowTitle, true)
            
            if (FinalID = "" || FinalID <= 0) {
                Return ""
            }
        }
        
        ; ğŸ“„ å¦‚æœçˆ¶æ–‡ä»¶å¤¹æœ‰ç›´æ¥æ–‡ä»¶ï¼Œä¸ºå®ƒä»¬åˆ›å»ºä¸€æ¡è®°å½•
        if (FirstLevelFiles.Length() > 0) {
            LocalData := CollectFilesInFolder(FirstLevelFiles, CurrentPath)
            
            if (LocalData.ClipData != "") {
                FinalID := InsertRecord(MainTable, DataTable, LocalData, WindowTitle, true)
                
                if (FinalID = "" || FinalID <= 0) {
                    Return ""
                }
            }
        }
    }
    
    Return FinalID
}

; 2.3 æ”¶é›†æ–‡ä»¶å¤¹æ•°æ® - CollectFolderData()
ProcessFolderMode(MainTable, DataTable, AllPaths, WindowTitle) {
    FinalID := ""
    
    ; ğŸ”„ éå†æ‰€æœ‰è·¯å¾„ï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä½†æ”¯æŒå¤šä¸ªï¼‰
    Loop, % AllPaths.Length() {
        CurrentPath := AllPaths[A_Index]
        CurrentAttrib := FileExist(CurrentPath)
        
        ; âš ï¸ è·³è¿‡éæ–‡ä»¶å¤¹
        if (!InStr(CurrentAttrib, "D")) {
            continue
        }
        
        ; ğŸ“‹ æ”¶é›†ç¬¬ä¸€å±‚å­æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
        FirstLevelFolders := []
        FirstLevelFiles := []
        
        ; æ”¶é›†å­æ–‡ä»¶å¤¹
        Loop, Files, %CurrentPath%\*.*, D
        {
            FirstLevelFolders.Push(A_LoopFileFullPath)
        }
        
        ; æ”¶é›†ç›´æ¥æ–‡ä»¶
        Loop, Files, %CurrentPath%\*.*, F
        {
            FirstLevelFiles.Push(A_LoopFileFullPath)
        }
        
        ; ğŸ“‚ ä¸ºæ¯ä¸ªå­æ–‡ä»¶å¤¹å•ç‹¬åˆ›å»ºè®°å½•
        Loop, % FirstLevelFolders.Length() {
            SubFolderPath := FirstLevelFolders[A_Index]
            
            ; æ”¶é›†å­æ–‡ä»¶å¤¹æ•°æ®
            LocalData := CollectFolderData(SubFolderPath)
            
            if (LocalData.ClipData = "") {
                continue
            }
            
            ; æ’å…¥è®°å½•
            FinalID := InsertRecord(MainTable, DataTable, LocalData, WindowTitle, true)
            
            if (FinalID = "" || FinalID <= 0) {
                Return ""
            }
        }
        
        ; ğŸ“„ å¦‚æœçˆ¶æ–‡ä»¶å¤¹æœ‰ç›´æ¥æ–‡ä»¶ï¼Œä¸ºå®ƒä»¬åˆ›å»ºä¸€æ¡è®°å½•
        if (FirstLevelFiles.Length() > 0) {
            LocalData := CollectFilesInFolder(FirstLevelFiles, CurrentPath)
            
            if (LocalData.ClipData != "") {
                FinalID := InsertRecord(MainTable, DataTable, LocalData, WindowTitle, true)
                
                if (FinalID = "" || FinalID <= 0) {
                    Return ""
                }
            }
        }
    }
    
    Return FinalID
}

; 2.4 æ”¶é›†æ–‡ä»¶å¤¹å†…æ–‡ä»¶æ•°æ® - CollectFilesInFolder()
CollectFilesInFolder(FilesList, ParentPath) {
    ; ğŸ“¦ åˆå§‹åŒ–æ•°æ®ç»“æ„
    data := {}
    data.ClipData := ""
    data.Content := ""
    data.Remark := ""
    data.Identifier := "ğŸ“"
    data.Format := "CF_HDROP,ğŸ“"
    data.Group := ""
    data.Bytes := ""
    
    LocalValidCount := FilesList.Length()
    LocalTotalSize := 0
    LocalFilePathsList := ""
    
    ; ğŸ“„ éå†æ‰€æœ‰æ–‡ä»¶
    Loop, % FilesList.Length() {
        FilePath := FilesList[A_Index]
        LocalFilePathsList .= FilePath . "`n"
        FileGetSize, FileSize, %FilePath%, B
        LocalTotalSize += FileSize
    }
    
    ; ğŸ§¹ æ¸…ç†è·¯å¾„åˆ—è¡¨
    LocalFilePathsList := RTrim(LocalFilePathsList, "`n")
    data.ClipData := LocalFilePathsList
    
    ; ğŸ“ æ ¼å¼åŒ–å¤§å°
    LocalSizeStr := FormatFileSize(LocalTotalSize)
    data.Bytes := LocalSizeStr
    
    ; ğŸ“ æå–çˆ¶æ–‡ä»¶å¤¹ä¿¡æ¯
    SplitPath, ParentPath, , LocalFileDir, , LocalFileNameNoExt
    SplitPath, LocalFileDir, , , , LocalParentDir
    data.Group := LocalFileDir ? LocalParentDir : ""
    
    ; âœï¸ ç”Ÿæˆå†…å®¹æè¿°
    data.Content := "Copied Files from - " . LocalFileNameNoExt . " | æ•°é‡: " . LocalValidCount . " | æœ‰æ•ˆ: " . LocalValidCount . " | å¤§å°: " . LocalSizeStr
    data.Remark := ParentPath
    
    Return data
}

; 2.5 æ–‡ä»¶æ¨¡å¼å¤„ç† - ProcessFilesMode()
ProcessFilesMode(MainTable, DataTable, AllPaths, Group, WindowTitle) {
    ValidCount := 0
    TotalSize := 0
    FilePathsList := ""
    
    ; ğŸ“‹ æ”¶é›†æ–‡ä»¶ç±»å‹æ ‡è¯†ç¬¦å’Œæ‰©å±•å
    UniqueIdentifiers := {}
    UniqueExts := {}
    
    ; ğŸ”„ éå†æ‰€æœ‰æ–‡ä»¶
    Loop, % AllPaths.Length() {
        CurrentPath := AllPaths[A_Index]
        FilePathsList .= CurrentPath . "`n"
        
        ; ğŸ“ è®¡ç®—æ–‡ä»¶å¤§å°
        FileGetSize, FileSize, %CurrentPath%, B
        TotalSize += FileSize
        ValidCount++
        
        ; ğŸ·ï¸ è·å–æ–‡ä»¶æ‰©å±•å
        SplitPath, CurrentPath, , , FileExt
        
        ; ğŸ¨ è·å–æ–‡ä»¶ç±»å‹ç¬¦å·
        Symbol := GetFileTypeSymbol(CurrentPath, FileExt)
        if (Symbol != "") {
            SymbolsList := StrSplit(Symbol, ",")
            for _, s in SymbolsList {
                UniqueIdentifiers[s] := 1
            }
        }
        
        ; ğŸ“ è®°å½•æ‰©å±•å
        if (FileExt != "") {
            UniqueExts[FileExt] := 1
        }
    }
    
    ; ğŸ§¹ æ¸…ç†è·¯å¾„åˆ—è¡¨
    FilePathsList := RTrim(FilePathsList, "`n")
    
    ; ğŸ”— ç»„åˆæ ‡è¯†ç¬¦
    IdentifierStr := ""
    for k, v in UniqueIdentifiers {
        IdentifierStr .= k . ","
    }
    Identifier := RTrim(IdentifierStr, ",")
    
    ; ğŸ·ï¸ æ„å»ºæ ¼å¼å­—ç¬¦ä¸²
    Format := "CF_HDROP"
    if (Identifier != "") {
        Format .= "," . Identifier
    }
    
    ; ğŸ“ æ·»åŠ æ‰©å±•ååˆ°æ ¼å¼å­—ç¬¦ä¸²
    ExtStr := ""
    for k, v in UniqueExts {
        ExtStr .= k . ","
    }
    ExtStr := RTrim(ExtStr, ",")
    
    if (ExtStr != "") {
        Format .= "," . ExtStr
    }
    
    ; ğŸ“ æ ¼å¼åŒ–æ€»å¤§å°
    SizeStr := FormatFileSize(TotalSize)
    
    ; ğŸ“ è·å–ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ä¿¡æ¯ï¼ˆç”¨äºå¤‡æ³¨ï¼‰
    Path := AllPaths[1]
    SplitPath, Path, FileName, , , FileNameNoExt
    
    ; ğŸ“¦ æ„å»ºæ•°æ®å¯¹è±¡
    data := {}
    data.ClipData := FilePathsList
    data.Content := "Copied File - " . FileNameNoExt . " | æ•°é‡: " . AllPaths.Length() . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
    data.Remark := FileName
    data.Identifier := Identifier
    data.Format := Format
    data.Group := Group
    data.Bytes := SizeStr
    
    ; ğŸ’¾ æ’å…¥è®°å½•
    FinalID := InsertRecord(MainTable, DataTable, data, WindowTitle, false)
    
    Return FinalID
}

; 2.6 è¾…åŠ©å‡½æ•° - FormatFileSize()
FormatFileSize(Bytes) {
    ; ğŸ“ æ ¼å¼åŒ–æ–‡ä»¶å¤§å°ä¸ºäººç±»å¯è¯»æ ¼å¼
    if (Bytes < 1024) {
        Return Bytes . " B"
    } else if (Bytes < 1024 * 1024) {
        Return Round(Bytes / 1024, 2) . " KB"
    } else if (Bytes < 1024 * 1024 * 1024) {
        Return Round(Bytes / (1024 * 1024), 2) . " MB"
    } else {
        Return Round(Bytes / (1024 * 1024 * 1024), 2) . " GB"
    }
}

; 2.7 è¾…åŠ©å‡½æ•° - GetFileTypeSymbol()ï¼ˆå·²å­˜åœ¨ï¼Œè¿™é‡Œæä¾›å®Œæ•´ç‰ˆï¼‰
GetFileTypeSymbol(filePath, fileExt) {
    ; ğŸ“ æ–‡ä»¶å¤¹
    if (InStr(FileExist(filePath), "D")) {
        Return "ğŸ“"
    }
    
    ; ğŸµ éŸ³ä¹æ–‡ä»¶åˆ†ç±»
    lossyMusicExts := "mp3,aac,m4a,ogg"
    losslessMusicExts := "flac,alac,ape"
    uncompressedMusicExts := "wav,aiff"
    specialMusicExts := "dsf,dff,mid"
    
    ; ğŸ¬ è§†é¢‘æ–‡ä»¶
    videoExts := "mp4,avi,mkv,wmv,flv,mov"
    
    ; ğŸ–¼ï¸ å›¾ç‰‡æ–‡ä»¶
    imageExts := "jpg,jpeg,png,gif,bmp,tiff"
    
    ; ğŸ“„ æ–‡æ¡£æ–‡ä»¶
    docExts := "doc,docx,pdf,txt,rtf"
    
    ; ğŸ¯ æ ¹æ®æ‰©å±•åè¿”å›ç¬¦å·
    if (InStr(lossyMusicExts, fileExt))
        Return "ğŸ§,â™«"
    else if (InStr(losslessMusicExts, fileExt) || (fileExt = "m4a" && InStr(filePath, "ALAC")))
        Return "ğŸ¼,â™«"
    else if (InStr(uncompressedMusicExts, fileExt))
        Return "ğŸ“€,â™«"
    else if (InStr(specialMusicExts, fileExt))
        Return "ğŸ¶,â™«"
    else if (InStr(videoExts, fileExt))
        Return "ğŸ¥"
    else if (InStr(imageExts, fileExt))
        Return "ğŸ–¼ï¸"
    else if (InStr(docExts, fileExt))
        Return "ğŸ“"
    else
        Return "ğŸ“"
}

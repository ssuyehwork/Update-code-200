ClipboardChanged(type) {
    Global SQLiteDB, DBPath, IsCopying, ClipboardLock, ProcessingContext, TransactionActive, TransactionOwner
    Global G_last_insert_rowid, G_last_insert_Main_ID, G_last_insert_Main_TableName, g_CurrentRecord
    
    ; ğŸ”’ æ£€æŸ¥é”å®šçŠ¶æ€
    if (ClipboardLock != 0) {
        Return
    }
  
    ; ğŸªŸ è·å–çª—å£ä¿¡æ¯
    WinGet, ActiveID, ID, A
    WinGetTitle, WindowTitle, ahk_id %ActiveID%
    if (InStr(WindowTitle, "å°è±¡è®°å¿†_5")) {
        Return
    }
    if (type != 1 && type != 2) {
        Return
    }
    
    ; ğŸ” è®¾ç½®é”å®š
    ClipboardLock := 3
    ProcessingContext := "Clipboard"
    FinalID := ""
    MainTable := ""
    
    try {
        ; ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“
        if (!InitDB(DBPath)) {
            LoadData()
            Return
        }
        
        ; âœ… æµ‹è¯•æ•°æ®åº“æ˜¯å¦å¯å†™
        TestWriteSQL := "CREATE TEMP TABLE IF NOT EXISTS _test_write (id INTEGER); DROP TABLE IF EXISTS _test_write;"
        if (!SQLiteDB.Exec(TestWriteSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4103698 æ•°æ®åº“è¢«å ç”¨æˆ–æ— å†™å…¥æƒé™`n`né”™è¯¯: %ErrorMsg%`nè·¯å¾„: %DBPath%
            LoadData()
            Return
        }
        
        ; ğŸ¯ æ ¹æ®å‰ªè´´æ¿å†…å®¹åŠ¨æ€å†³å®šä¸»è¡¨åç§°
        isFileSystemContent := false
        }
        
        Sleep, 100
        
        ; ğŸš€ å¼€å§‹äº‹åŠ¡
        if (!BeginSafeTransaction("ClipboardChanged")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1938940 å¼€å§‹äº‹åŠ¡å¤±è´¥ï¼
            LoadData()
            Return
        }
        
        ; ğŸ“‹ å¤„ç†å‰ªè´´æ¿å†…å®¹ï¼ˆè°ƒåº¦åˆ°å¯¹åº”å¤„ç†å‡½æ•°ï¼‰
        if (DllCall("IsClipboardFormatAvailable", "UInt", 15)) {
            ; CF_HDROP - æ–‡ä»¶/æ–‡ä»¶å¤¹
            FinalID := ProcessFileClipboard(MainTable, DataTable, WindowTitle)
        } else {
            ; CF_UNICODETEXT - æ–‡æœ¬
            FinalID := ProcessTextClipboard(MainTable, DataTable, WindowTitle)
        }
        
        ; âŒ æ£€æŸ¥å¤„ç†ç»“æœ
        if (FinalID = "" || FinalID <= 0) {
            RollbackSafeTransaction("ClipboardChanged")
            LoadData()
            Return
        }
        
        ; ğŸ’¾ æ›´æ–°æœ€åæ’å…¥IDè®°å½•
        UpdateLastInsertID(FinalID)
        
        ; âœ… æäº¤äº‹åŠ¡
        if (!CommitSafeTransaction("ClipboardChanged")) {
            RollbackSafeTransaction("ClipboardChanged")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3828190 äº‹åŠ¡æäº¤å¤±è´¥ï¼
            LoadData()
            Return
        }
        
        ; ğŸ” éªŒè¯å±æ€§å…³è”
        AttrCount := VerifyAllAttributes(FinalID, MainTable)
        if (AttrCount < 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5020111 å±æ€§å…³è”éªŒè¯å¤±è´¥
        }
        
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("ClipboardChanged")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4846379 ClipboardChanged å¼‚å¸¸: %eMessage%
    } finally {
        ; ğŸ”„ æ›´æ–°å…¨å±€å˜é‡
        G_last_insert_rowid := FinalID
        g_CurrentRecord.ID := FinalID
        g_CurrentRecord.TableName := MainTable
        SB_SetText("ClipboardChanged: å¡«å……ç¼“å­˜ ID=" . FinalID)
        
        ; ğŸ”“ è§£é”
        ProcessingContext := ""
        if (ClipboardLock = 3) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        
        ; ğŸ”„ åˆ·æ–°ç•Œé¢
        LoadData()
        GetGlobalMaxSortValue()
    }
    Return
}

; 2.1 ä¸»è°ƒåº¦å‡½æ•° - ProcessFileClipboard()
ProcessFileClipboard(MainTable, DataTable, WindowTitle) {
    ; ğŸ“‹ è§£æå‰ªè´´æ¿ä¸­çš„æ‰€æœ‰æ–‡ä»¶è·¯å¾„
    ClipData := Clipboard
    AllPaths := []
    FileCount := 0
    
    Loop, Parse, Clipboard, `n, `r
    {
        Path := Trim(A_LoopField)
        if (Path != "" && FileExist(Path)) {
            AllPaths.Push(Path)
            FileCount++
        }
    }
    
    ; âŒ æ²¡æœ‰æœ‰æ•ˆè·¯å¾„
    if (FileCount = 0) {
        Return ""
    }
    
    ; ğŸ¯ åˆ¤æ–­æ˜¯æ–‡ä»¶å¤¹æ¨¡å¼è¿˜æ˜¯æ–‡ä»¶æ¨¡å¼
    Path := AllPaths[1]
    FileAttrib := FileExist(Path)
    isFolderMode := InStr(FileAttrib, "D")
    
    ; ğŸ“ è·å–åˆ†ç»„ï¼ˆçˆ¶æ–‡ä»¶å¤¹åï¼‰
    SplitPath, Path, , FileDir
    Group := ""
    if (FileDir) {
        SplitPath, FileDir, Group
    }
    
    FinalID := ""
    
    if (isFolderMode) {
        ; ğŸ“‚ æ–‡ä»¶å¤¹æ¨¡å¼ï¼šå¤„ç†æ–‡ä»¶å¤¹åŠå…¶å­é¡¹
        FinalID := ProcessFolderMode(MainTable, DataTable, AllPaths, WindowTitle)
    } else {
        ; ğŸ“„ æ–‡ä»¶æ¨¡å¼ï¼šå¤„ç†å•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶
        FinalID := ProcessFilesMode(MainTable, DataTable, AllPaths, Group, WindowTitle)
    }
    
    Return FinalID
}

; 2.2 æ–‡ä»¶å¤¹æ¨¡å¼å¤„ç† - ProcessFolderMode()
ProcessFolderMode(MainTable, DataTable, AllPaths, WindowTitle) {
    FinalID := ""
    
    ; ğŸ”„ éå†æ‰€æœ‰è·¯å¾„ï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä½†æ”¯æŒå¤šä¸ªï¼‰
    Loop, % AllPaths.Length() {
        CurrentPath := AllPaths[A_Index]
        CurrentAttrib := FileExist(CurrentPath)
        
        ; âš ï¸ è·³è¿‡éæ–‡ä»¶å¤¹
        if (!InStr(CurrentAttrib, "D")) {
            continue
        }
        
        ; ğŸ“‹ æ”¶é›†ç¬¬ä¸€å±‚å­æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
        FirstLevelFolders := []
        FirstLevelFiles := []
        
        ; æ”¶é›†å­æ–‡ä»¶å¤¹
        Loop, Files, %CurrentPath%\*.*, D
        {
            FirstLevelFolders.Push(A_LoopFileFullPath)
        }
        
        ; æ”¶é›†ç›´æ¥æ–‡ä»¶
        Loop, Files, %CurrentPath%\*.*, F
        {
            FirstLevelFiles.Push(A_LoopFileFullPath)
        }
        
        ; ğŸ“‚ ä¸ºæ¯ä¸ªå­æ–‡ä»¶å¤¹å•ç‹¬åˆ›å»ºè®°å½•
        Loop, % FirstLevelFolders.Length() {
            SubFolderPath := FirstLevelFolders[A_Index]
            
            ; æ”¶é›†å­æ–‡ä»¶å¤¹æ•°æ®
            LocalData := CollectFolderData(SubFolderPath)
            
            if (LocalData.ClipData = "") {
                continue
            }
            
            ; æ’å…¥è®°å½•
            FinalID := InsertRecord(MainTable, DataTable, LocalData, WindowTitle, true)
            
            if (FinalID = "" || FinalID <= 0) {
                Return ""
            }
        }
        
        ; ğŸ“„ å¦‚æœçˆ¶æ–‡ä»¶å¤¹æœ‰ç›´æ¥æ–‡ä»¶ï¼Œä¸ºå®ƒä»¬åˆ›å»ºä¸€æ¡è®°å½•
        if (FirstLevelFiles.Length() > 0) {
            LocalData := CollectFilesInFolder(FirstLevelFiles, CurrentPath)
            
            if (LocalData.ClipData != "") {
                FinalID := InsertRecord(MainTable, DataTable, LocalData, WindowTitle, false)
                
                if (FinalID = "" || FinalID <= 0) {
                    Return ""
                }
            }
        }
    }
    
    Return FinalID
}

; 2.3 æ”¶é›†æ–‡ä»¶å¤¹æ•°æ® - CollectFolderData()
CollectFolderData(SubFolderPath) {
    data := {}
    data.ClipData := ""
    data.Content := ""
    data.Remark := ""
    data.Identifier := "ğŸ“"
    data.Format := "CF_HDROP,ğŸ“"
    data.Group := ""
    data.Bytes := ""
    
    LocalValidCount := 0
    LocalTotalSize := 0
    LocalFilePathsList := ""
    
    Loop, Files, %SubFolderPath%\*.*, D
    {
        LocalFilePathsList .= A_LoopFileFullPath . "`n"
        LocalValidCount++
        
        Loop, Files, %A_LoopFileFullPath%\*.*, FR
        {
            FileGetSize, FileSize, %A_LoopFileFullPath%, B
            LocalTotalSize += FileSize
        }
    }
    
    Loop, Files, %SubFolderPath%\*.*, F
    {
        LocalFilePathsList .= A_LoopFileFullPath . "`n"
        LocalValidCount++
        FileGetSize, FileSize, %A_LoopFileFullPath%, B
        LocalTotalSize += FileSize
    }
    
    LocalFilePathsList := RTrim(LocalFilePathsList, "`n")
    data.ClipData := LocalFilePathsList
    
    LocalSizeStr := FormatFileSize(LocalTotalSize)
    data.Bytes := LocalSizeStr
    
    SplitPath, SubFolderPath, LocalFileName, LocalFileDir, , LocalFileNameNoExt
    SplitPath, LocalFileDir, , , , LocalParentDir
    data.Group := LocalFileDir ? LocalParentDir : ""
    
    data.Content := "Copied Folder - " . LocalFileNameNoExt . " | æ•°é‡: 1 | æœ‰æ•ˆ: " . LocalValidCount . " | å¤§å°: " . LocalSizeStr
    data.Remark := SubFolderPath
    
    Return data
}

; 2.4 æ”¶é›†æ–‡ä»¶å¤¹å†…æ–‡ä»¶æ•°æ® - CollectFilesInFolder()
CollectFilesInFolder(FilesList, ParentPath) {
    data := {}
    data.ClipData := ""
    data.Content := ""
    data.Remark := ""
    data.Identifier := "ğŸ“"
    data.Format := "CF_HDROP,ğŸ“"
    data.Group := ""
    data.Bytes := ""
    
    LocalValidCount := FilesList.Length()
    LocalTotalSize := 0
    LocalFilePathsList := ""
    
    Loop, % FilesList.Length() {
        FilePath := FilesList[A_Index]
        LocalFilePathsList .= FilePath . "`n"
        FileGetSize, FileSize, %FilePath%, B
        LocalTotalSize += FileSize
    }
        Return Bytes . " B"
    } else if (Bytes < 1024 * 1024) {
        Return Round(Bytes / 1024, 2) . " KB"
    } else if (Bytes < 1024 * 1024 * 1024) {
    IdentifierStr := ""
    for k, v in UniqueIdentifiers {
        IdentifierStr .= k . ","
    }
    Identifier := RTrim(IdentifierStr, ",")
    
    ; ğŸ·ï¸ æ„å»ºæ ¼å¼å­—ç¬¦ä¸²
    Format := "CF_HDROP"
    if (Identifier != "") {
        Format .= "," . Identifier
    }
    
    ; ğŸ“ æ·»åŠ æ‰©å±•ååˆ°æ ¼å¼å­—ç¬¦ä¸²
    ExtStr := ""
    for k, v in UniqueExts {
        Return Bytes . " B"
    } else if (Bytes < 1024 * 1024) {
        Return Round(Bytes / 1024, 2) . " KB"
    } else if (Bytes < 1024 * 1024 * 1024) {
        Return Round(Bytes / (1024 * 1024), 2) . " MB"
    } else {
        Return Round(Bytes / (1024 * 1024 * 1024), 2) . " GB"
    }
}

; 2.7 è¾…åŠ©å‡½æ•° - GetFileTypeSymbol()ï¼ˆå·²å­˜åœ¨ï¼Œè¿™é‡Œæä¾›å®Œæ•´ç‰ˆï¼‰
GetFileTypeSymbol(filePath, fileExt) {
    ; ğŸ“ æ–‡ä»¶å¤¹
    if (InStr(FileExist(filePath), "D")) {
        Return "ğŸ“"
    }
    
    ; ğŸµ éŸ³ä¹æ–‡ä»¶åˆ†ç±»
    lossyMusicExts := "mp3,aac,m4a,ogg"
    losslessMusicExts := "flac,alac,ape"
    uncompressedMusicExts := "wav,aiff"
    specialMusicExts := "dsf,dff,mid"
    
    ; ğŸ¬ è§†é¢‘æ–‡ä»¶
    videoExts := "mp4,avi,mkv,wmv,flv,mov"
    
    ; ğŸ–¼ï¸ å›¾ç‰‡æ–‡ä»¶
    imageExts := "jpg,jpeg,png,gif,bmp,tiff"
    
    ; ğŸ“„ æ–‡æ¡£æ–‡ä»¶
    docExts := "doc,docx,pdf,txt,rtf"
    
    ; ğŸ¯ æ ¹æ®æ‰©å±•åè¿”å›ç¬¦å·
    if (InStr(lossyMusicExts, fileExt))
        Return "ğŸ§,â™«"
    else if (InStr(losslessMusicExts, fileExt) || (fileExt = "m4a" && InStr(filePath, "ALAC")))
        Return "ğŸ¼,â™«"
    else if (InStr(uncompressedMusicExts, fileExt))
        Return "ğŸ“€,â™«"
    else if (InStr(specialMusicExts, fileExt))
        Return "ğŸ¶,â™«"
    else if (InStr(videoExts, fileExt))
        Return "ğŸ¥"
    else if (InStr(imageExts, fileExt))
        Return "ğŸ–¼ï¸"
    else if (InStr(docExts, fileExt))
        Return "ğŸ“"
    else
        Return "ğŸ“"
}

ProcessTextClipboard(MainTable, DataTable, WindowTitle) {
    ; ğŸ“‹ è·å–å¹¶æ¸…ç†å‰ªè´´æ¿æ–‡æœ¬
    ClipData := Clipboard
    ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
    ClipData := Trim(ClipData)
    
    ; âŒ ç©ºæ–‡æœ¬æˆ–çº¯ç©ºç™½
    if (ClipData = "" || RegExMatch(ClipData, "^\s*$")) {
    data.Content := ""
    data.Remark := ""
    data.Identifier := ""
    data.Format := "CF_UNICODETEXT"
    data.Group := ""
    data.Bytes := ""
    
    ; ğŸ” æ£€æŸ¥ç¬¬ä¸€è¡Œè·¯å¾„æ˜¯å¦å­˜åœ¨
    FirstAttrib := FileExist(FirstLine)
    SplitPath, FirstLine, FileName, FileDir, FileExt, FileNameNoExt
    
    ; ğŸ¯ åˆ¤æ–­æ˜¯æ–‡ä»¶å¤¹è·¯å¾„è¿˜æ˜¯æ–‡ä»¶è·¯å¾„
    if (InStr(FirstAttrib, "D")) {
        ; ğŸ“ æ–‡ä»¶å¤¹è·¯å¾„
        data.Identifier := "ğŸ“ğ“Ÿ"
        data.Format := "CF_UNICODETEXT,ğŸ“ğ“Ÿ"
    } else {
        ; ğŸ“„ æ–‡ä»¶è·¯å¾„
        Symbol := GetFileTypeSymbol(FirstLine, FileExt)
        data.Identifier := Symbol . "ğ“Ÿ"
        data.Format := "CF_UNICODETEXT," . data.Identifier
        if (FileExt != "") {
            data.Format .= "," . FileExt
        }
    }
    
    ; ğŸ“Š ç»Ÿè®¡æ–‡ä»¶å’Œå¤§å°
    FileCount := 0
    ValidCount := 0
    TotalSize := 0
    
    Loop, % lines.Length() {
        Path := Trim(lines[A_Index])
        if (Path != "" && FileExist(Path)) {
            FileAttrib := FileExist(Path)
            FileCount++
            
            if (InStr(FileAttrib, "D")) {
                ; ğŸ“‚ æ–‡ä»¶å¤¹ï¼šç»Ÿè®¡å†…éƒ¨æ–‡ä»¶
                Loop, Files, %Path%\*.*, F
                {
                    if (FileExist(A_LoopFileFullPath)) {
                        ValidCount++
                        FileGetSize, FileSize, %A_LoopFileFullPath%, B
                        TotalSize += FileSize
                    }
                }
            } else {
                ; ğŸ“„ æ–‡ä»¶ï¼šç›´æ¥ç»Ÿè®¡
                ValidCount++
                FileGetSize, FileSize, %Path%, B
                TotalSize += FileSize
            }
        }
    }
    
    ; ğŸ“ æ ¼å¼åŒ–å¤§å°
    SizeStr := FormatFileSize(TotalSize)
    data.Bytes := SizeStr
    
    ; ğŸ“ æå–åˆ†ç»„ï¼ˆçˆ¶æ–‡ä»¶å¤¹ï¼‰
    GroupName := ""
    if (FileDir) {
        SplitPath, FileDir, GroupName
    }
    data.Group := GroupName
    
    ; âœï¸ ç”Ÿæˆå†…å®¹æè¿°
    if (InStr(FirstAttrib, "D")) {
        data.Content := "Copied Folder Path - " . FileNameNoExt . " | æ•°é‡: " . FileCount . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
    } else {
        data.Content := "Copied File Path - " . FileNameNoExt . " | æ•°é‡: " . FileCount . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
    }
    
    ; ğŸ“ å¤‡æ³¨ï¼šå°†å¤šè¡Œè·¯å¾„åˆå¹¶ä¸ºå•è¡Œ
    data.Remark := RegExReplace(ClipData, "[\r\n]+", " ")
    
    Return data
}

ProcessURLText(ClipData) {
    ; ğŸ“¦ åˆå§‹åŒ–æ•°æ®ç»“æ„
    data := {}
    data.ClipData := ClipData
    data.Content := ClipData
    data.Remark := ""
    data.Identifier := "ğŸ”—"
    data.Format := "CF_UNICODETEXT,ğŸ”—"
    data.Group := ""
    data.Bytes := ""
    
    ; ğŸŒ æå–åŸŸåä½œä¸ºå¤‡æ³¨
    if (RegExMatch(ClipData, "://([^/]+)", domainMatch)) {
        fullDomain := domainMatch1
        
        ; ğŸ” å°è¯•æå–ä¸»åŸŸåï¼ˆå»æ‰ www.ï¼‰
        if (RegExMatch(fullDomain, "^(?:www\.)?([^.]+)\.[^.]+$", mainDomainMatch)) {
            data.Remark := mainDomainMatch1
        } else {
            data.Remark := fullDomain
        }
    } else {
        ; âš ï¸ æ— æ³•æå–åŸŸåï¼Œä½¿ç”¨å‰200ä¸ªå­—ç¬¦
        data.Remark := SubStr(ClipData, 1, 200)
    }
    
    Return data
}

ProcessPlainText(ClipData, lines, FirstLine) {
    ; ğŸ“¦ åˆå§‹åŒ–æ•°æ®ç»“æ„
    data := {}
    data.ClipData := ClipData
    data.Content := ""
    data.Remark := FirstLine
    data.Identifier := ""
    data.Format := "CF_UNICODETEXT"
    data.Group := ""
    data.Bytes := ""
    
    ; ğŸ“ è®¡ç®—å­—èŠ‚æ•°ï¼ˆUTF-8ç¼–ç ï¼‰
    ByteCount := StrPut(ClipData, "UTF-8") - 1
    BytesStr := FormatFileSize(ByteCount)
    data.Bytes := BytesStr
    
    ; ğŸ“Š ç»Ÿè®¡å­—ç¬¦æ•°å’Œè¡Œæ•°
    CharCount := StrLen(ClipData)
    LineCount := lines.Length()
    
    ; âœï¸ ç”Ÿæˆå†…å®¹æè¿°
    data.Content := "[æ–‡æœ¬] | " . CharCount . " å­—ç¬¦ | " . BytesStr . " | " . LineCount . " è¡Œ"
    
    Return data
}

InsertRecord(MainTable, DataTable, data, WindowTitle, isFolderMode) {
    Global SQLiteDB, G_last_insert_rowid, G_last_insert_Main_ID, G_last_insert_Main_TableName
    
    ; ğŸ“‹ æå–æ•°æ®
    ClipData := data.ClipData
    Content := data.Content
    Remark := data.Remark
    Identifier := data.Identifier
    Format := data.Format
    Group := data.Group
    Bytes := data.Bytes
    
    ; ğŸ” è®¡ç®—å“ˆå¸Œå€¼
    HashValue := ""
    try {
        if (ClipData != "") {
            ClipDataLen := StrLen(ClipData)
            if (ClipDataLen > 10000000) {
                ; è¶…è¿‡10MBï¼Œä½¿ç”¨æˆªæ–­æ•°æ®è®¡ç®—å“ˆå¸Œ
                TruncatedData := SubStr(ClipData, 1, 10000000)
                HashValue := Crypt.Hash.Str(TruncatedData, "SHA256") . "_TRUNCATED"
            } else {
                HashValue := Crypt.Hash.Str(ClipData, "SHA256")
            }
        }
    } catch e {
        ; å“ˆå¸Œè®¡ç®—å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        HashValue := "HASH_FAILED_" . A_TickCount . "_" . StrLen(ClipData)
    }
    
    ; ğŸ”¢ è·å–æ–°çš„æ’åºå€¼
    NewSortValue := GetNewSortValue()
    if (NewSortValue = "") {
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š6001 è·å–æ’åºå€¼å¤±è´¥
        Return ""
    }
    
    ; ğŸ” æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå“ˆå¸Œå€¼çš„è®°å½•
    ExistingID := ""
    CheckSQL := "SELECT ID FROM " . MainTable . " WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
    CheckResult := {}
    if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
        ExistingID := CheckResult.Rows[1][1]
    }
    
    ; ğŸ§¹ æ¸…ç†å’ŒéªŒè¯æ•°æ®
    if (StrLen(Content) > 1000000) {
        Content := SubStr(Content, 1, 1000000)
    }
    if (StrLen(Remark) > 1000) {
        Remark := SubStr(Remark, 1, 1000)
    }
    
    ; è®¾ç½®é»˜è®¤å€¼
    HashValue := HashValue ? HashValue : ""
    Bytes := Bytes ? Bytes : ""
    WindowDetail := WindowTitle ? WindowTitle : ""
    Identifier := Identifier ? Identifier : ""
    Format := Format ? Format : ""
    Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
    Content := Content ? RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
    Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
    
    ; ğŸ·ï¸ è§£æåº”ç”¨åç§°
    AppName := "æœªçŸ¥åº”ç”¨"
    if (RegExMatch(WindowTitle, "(.+)\s*-\s*(.+)$", Match)) {
        AppName := Trim(Match2)
    } else {
        AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
    }
    
    ; ğŸ”’ SQLè½¬ä¹‰
    EscapedHashValue := StrReplace(HashValue, "'", "''")
    EscapedBytes := StrReplace(Bytes, "'", "''")
    EscapedWindowDetail := StrReplace(WindowTitle, "'", "''")
    EscapedRemark := StrReplace(Remark, "'", "''")
    EscapedContent := StrReplace(Content, "'", "''")
    EscapedFormat := StrReplace(Format, "'", "''")
    EscapedClipData := StrReplace(ClipData, "'", "''")
    
    FinalID := ""
    
    ; ğŸ¯ æ ¹æ®æ˜¯å¦å­˜åœ¨é€‰æ‹©æ›´æ–°æˆ–æ’å…¥
    if (ExistingID != "") {
        ; ğŸ”„ æ›´æ–°ç°æœ‰è®°å½•
        FinalID := UpdateExistingRecord(MainTable, DataTable, ExistingID, NewSortValue, EscapedContent, EscapedBytes, EscapedWindowDetail, EscapedFormat, EscapedClipData)
    } else {
        ; â• æ’å…¥æ–°è®°å½•
        FinalID := InsertNewRecord(MainTable, DataTable, NewSortValue, EscapedHashValue, EscapedBytes, EscapedWindowDetail, EscapedRemark, EscapedContent, EscapedFormat, EscapedClipData)
    }
    
    ; âŒ æ£€æŸ¥æ“ä½œç»“æœ
    if (FinalID = "" || FinalID <= 0) {
        Return ""
    }
    
    ; ğŸ”„ æ›´æ–°å…¨å±€å˜é‡
    G_last_insert_rowid := FinalID
    G_last_insert_Main_ID := FinalID
    G_last_insert_Main_TableName := MainTable
    
    ; ğŸ·ï¸ æ”¶é›†å¹¶æ’å…¥å±æ€§
    InsertAttributes(MainTable, FinalID, ClipData, Format, Identifier, Remark, Group, AppName, isFolderMode)
    
    Return FinalID
}

UpdateExistingRecord(MainTable, DataTable, ExistingID, NewSortValue, EscapedContent, EscapedBytes, EscapedWindowDetail, EscapedFormat, EscapedClipData) {
    Global SQLiteDB
    
    ; ğŸ”„ æ›´æ–°ä¸»è¡¨
    UpdateSQL := "UPDATE " . MainTable . " SET "
               . "æ’åº = " . NewSortValue . ", "
               . "æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, "
               . "ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), "
               . "è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), "
               . "å†…å®¹ = '" . EscapedContent . "', "
               . "å­—èŠ‚ = '" . EscapedBytes . "', "
               . "çª—å£è¯¦æƒ… = '" . EscapedWindowDetail . "' "
               . "WHERE ID = " . ExistingID . ";"
    
    RetryCount := 3
    Success := false
    ErrorMsg := ""
    
    while (RetryCount > 0) {
        if (SQLiteDB.Exec(UpdateSQL)) {
            Success := true
            break
        }
        ErrorMsg := SQLiteDB._ErrMsg()
        if (InStr(ErrorMsg, "SQLITE_BUSY")) {
            Sleep, 100
            RetryCount--
            continue
        }
        break
    }
    
    if (!Success) {
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3720054 æ›´æ–°ä¸»è¡¨å¤±è´¥: %ErrorMsg%
        Return ""
    }
    
    ; ğŸ—‘ï¸ åˆ é™¤æ—§æ•°æ®è¡¨è®°å½•
    DeleteDataSQL := "DELETE FROM " . DataTable . " WHERE lParentID = " . ExistingID . ";"
    RetryCount := 3
    Success := false
    
    while (RetryCount > 0) {
        if (SQLiteDB.Exec(DeleteDataSQL)) {
            Success := true
            break
        }
        ErrorMsg := SQLiteDB._ErrMsg()
        if (InStr(ErrorMsg, "SQLITE_BUSY")) {
            Sleep, 100
            RetryCount--
            continue
        }
        break
    }
    
    if (!Success) {
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3724787 åˆ é™¤æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
        Return ""
    }
    
    ; â• æ’å…¥æ–°æ•°æ®è¡¨è®°å½•
    InsertDataSQL := "INSERT INTO " . DataTable . " (lParentID, strClipBoardFormat, ooData) "
                   . "VALUES (" . ExistingID . ", '" . EscapedFormat . "', '" . EscapedClipData . "');"
    RetryCount := 3
    Success := false
    
    while (RetryCount > 0) {
        if (SQLiteDB.Exec(InsertDataSQL)) {
            Success := true
            break
        }
        ErrorMsg := SQLiteDB._ErrMsg()
        if (InStr(ErrorMsg, "SQLITE_BUSY")) {
            Sleep, 100
            RetryCount--
            continue
        }
        break
    }
    
    if (!Success) {
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3958064 æ’å…¥æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
        Return ""
    }
    
    Return ExistingID
}

InsertNewRecord(MainTable, DataTable, NewSortValue, EscapedHashValue, EscapedBytes, EscapedWindowDetail, EscapedRemark, EscapedContent, EscapedFormat, EscapedClipData) {
    Global SQLiteDB
    
    ; ğŸ†” åˆ†é…å…¨å±€IDï¼ˆä»ä¸­å¿ƒåŒ–è¡¨ï¼‰
    AllocSQL := "INSERT INTO ä¸­å¿ƒåŒ– (æ ‡è®°çŠ¶æ€) VALUES (0);"
    if (!SQLiteDB.Exec(AllocSQL)) {
        ErrorMsg := SQLiteDB._ErrMsg()
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5142862 åˆ†é…å…¨å±€IDå¤±è´¥: %ErrorMsg%
        Return ""
    }
    
    ; ğŸ“Š è·å–æ–°åˆ†é…çš„ID
    LastIDResult := {}
    FinalID := ""
    if (SQLiteDB.GetTable("SELECT last_insert_rowid() AS newid;", LastIDResult) && LastIDResult.RowCount > 0) {
        FinalID := LastIDResult.Rows[1][1]
    } else {
        ErrorMsg := SQLiteDB._ErrMsg()
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5224280 è·å–å…¨å±€IDå¤±è´¥: %ErrorMsg%
        Return ""
    }
    
    ; âœ”ï¸ éªŒè¯IDæœ‰æ•ˆæ€§
    if (FinalID = "" || FinalID <= 0) {
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5234045 å…¨å±€IDæ— æ•ˆ: FinalID = %FinalID%
        Return ""
    }
    
    ; â• æ’å…¥ä¸»è¡¨è®°å½•
    InsertMainSQL := "INSERT INTO " . MainTable . " ("
                   . "ID, å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, ç±»å‹, æ’åº, æ›´æ–°æ¬¡æ•°, "
                   . "åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, "
                   . "åˆ†ç»„, åº”ç”¨åç§°, æ ‡è¯†, å¤„ç†çŠ¶æ€, æç¤ºæ—¶é—´, æç¤º"
                   . ") VALUES ("
                   . FinalID . ", "
                   . "'" . EscapedHashValue . "', "
                   . "'" . EscapedBytes . "', "
                   . "'" . EscapedWindowDetail . "', "
                   . "'', "  ; ç±»å‹ï¼ˆç©ºï¼‰
                   . NewSortValue . ", "
                   . "0, "  ; æ›´æ–°æ¬¡æ•°
                   . "datetime('now', 'localtime'), "  ; åˆ›å»ºæ—¶é—´
                   . "datetime('now', 'localtime'), "  ; ä¿®æ”¹æ—¶é—´
                   . "datetime('now', 'localtime'), "  ; è®¿é—®æ—¶é—´
                   . "'" . EscapedRemark . "', "
                   . "'" . EscapedContent . "', "
                   . "'', "  ; åˆ†ç»„ï¼ˆç©ºï¼‰
                   . "'', "  ; åº”ç”¨åç§°ï¼ˆç©ºï¼‰
                   . "'', "  ; æ ‡è¯†ï¼ˆç©ºï¼‰
                   . "NULL, NULL, NULL"  ; å¤„ç†çŠ¶æ€ã€æç¤ºæ—¶é—´ã€æç¤º
                   . ");"
    
    RetryCount := 3
    Success := false
    ErrorMsg := ""
    
    while (RetryCount > 0) {
        if (SQLiteDB.Exec(InsertMainSQL)) {
            Success := true
            break
        }
        ErrorMsg := SQLiteDB._ErrMsg()
        if (InStr(ErrorMsg, "SQLITE_BUSY")) {
            Sleep, 100
            RetryCount--
            continue
        }
        break
    }
    
    if (!Success) {
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1333744 æ’å…¥ä¸»è¡¨å¤±è´¥: %ErrorMsg%
        Return ""
    }
    
    ; ğŸ·ï¸ æ ‡è®°ä¸­å¿ƒåŒ–è¡¨
    MarkSQL := "UPDATE ä¸­å¿ƒåŒ– SET æ ‡è®°çŠ¶æ€ = 1 WHERE Local_ID = " . FinalID . ";"
    SQLiteDB.Exec(MarkSQL)
    
    ; â• æ’å…¥æ•°æ®è¡¨è®°å½•
    InsertDataSQL := "INSERT INTO " . DataTable . " (lParentID, strClipBoardFormat, ooData) "
                   . "VALUES (" . FinalID . ", '" . EscapedFormat . "', '" . EscapedClipData . "');"
    RetryCount := 3
    Success := false
    
    while (RetryCount > 0) {
        if (SQLiteDB.Exec(InsertDataSQL)) {
            Success := true
            break
        }
        ErrorMsg := SQLiteDB._ErrMsg()
        if (InStr(ErrorMsg, "SQLITE_BUSY")) {
            Sleep, 100
            RetryCount--
            continue
        }
        break
    }
    
    if (!Success) {
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4653894 æ’å…¥æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
        Return ""
    }
    
    Return FinalID
}

GetNewSortValue() {
    Global SQLiteDB
    
    ; ğŸ“Š è·å–å½“å‰æœ€å¤§æ’åºå€¼
    GetMaxSortSQL := "SELECT COALESCE(""Record_Value"", 0) FROM ""åˆ†ç±»å­—å…¸_One"" "
                   . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' LIMIT 1;"
    MaxSortResult := {}
    CurrentMax := 0
    
    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
        CurrentMax := MaxSortResult.Rows[1][1] + 0  ; å¼ºåˆ¶è½¬ä¸ºæ•°å­—
    } else {
        ; ğŸ†• åˆå§‹åŒ–æ’åºå€¼è®°å½•
        InitSQL := "INSERT OR IGNORE INTO ""åˆ†ç±»å­—å…¸_One"" "
                 . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                 . "VALUES ('æ’åºå€¼', 'æœ€å¤§å€¼', '0', 0, datetime('now','localtime'));"
        if (!SQLiteDB.Exec(InitSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3646934 æ’åºå€¼åˆå§‹åŒ–å¤±è´¥: %ErrorMsg%
            Return ""
        }
        CurrentMax := 0
    }
    
    ; ğŸ”„ å¾ªç¯è·å–å”¯ä¸€æ’åºå€¼ï¼ˆå¤„ç†å¹¶å‘ï¼‰
    Loop {
        NewSortValue := CurrentMax + 1
        
        ; ğŸ”„ å°è¯•æ›´æ–°æœ€å¤§å€¼
        UpdateMaxSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" "
                      . "SET ""Record_Value"" = ?, ""Update_Time"" = datetime('now','localtime') "
                      . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' "
                      . "AND ""Record_Value"" = ?;"
        
        Success := false
        RetryCount := 3
        
        while (RetryCount > 0) {
            if (SQLiteDB.ExecuteWithParams) {
                if (SQLiteDB.ExecuteWithParams(UpdateMaxSQL, [NewSortValue, CurrentMax])) {
                    Success := true
                    break
                }
            } else {
                ; Fallbackï¼šä¸æ”¯æŒå‚æ•°åŒ–æŸ¥è¯¢
                FallbackSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" "
                             . "SET ""Record_Value"" = '" . NewSortValue . "', "
                             . """Update_Time"" = datetime('now','localtime') "
                             . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' "
                             . "AND ""Record_Value"" = '" . CurrentMax . "';"
                if (SQLiteDB.Exec(FallbackSQL)) {
                    Success := true
                    break
                }
            }
            
            ErrorMsg := SQLiteDB._ErrMsg()
            if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                Sleep, 50
                RetryCount--
                continue
            }
            
            ; ğŸ” æ£€æŸ¥å”¯ä¸€çº¦æŸå¤±è´¥ï¼ˆå¹¶å‘å†²çªï¼‰
            if (InStr(ErrorMsg, "UNIQUE constraint failed")) {
                ; é‡æ–°è¯»å–å½“å‰æœ€å¤§å€¼
                if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                    CurrentMax := MaxSortResult.Rows[1][1] + 0
                } else {
                    CurrentMax := 0
                }
                break  ; é€€å‡º whileï¼Œé‡è¯•å¤–å±‚ Loop
            }
            break
        }
        
        if (Success) {
            ; âœ… æ›´æ–°æˆåŠŸï¼Œè¿”å›æ–°æ’åºå€¼
            Return NewSortValue
        } else {
            ; âš ï¸ æ›´æ–°å¤±è´¥ï¼Œé‡æ–°è¯»å–å½“å‰æœ€å¤§å€¼
            if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                CurrentMax := MaxSortResult.Rows[1][1] + 0
            } else {
                CurrentMax := 0
            }
        }
    }
    
    Return ""
}
; ============================================================================
; ç¬¬5éƒ¨åˆ†ï¼šå±æ€§å¤„ç†æ¨¡å—
; ============================================================================

InsertAttributes(MainTable, FinalID, ClipData, Format, Identifier, Remark, Group, AppName, isFolderMode) {
    Global SQLiteDB, AllPaths
    
    Attributes := []
    Attributes.Push({Format: æ˜Ÿçº§, Value: 0})
    
    ; æ”¶é›†æ–‡ä»¶/æ–‡ä»¶å¤¹å±æ€§
    if (InStr(Format, CF_HDROP)) {
        if (isFolderMode) {
            ; æ–‡ä»¶å¤¹æ¨¡å¼
            FolderFullPath := Remark
            if (FolderFullPath != " && InStr(FileExist(FolderFullPath), D)) {
 SplitPath, FolderFullPath, FolderName
 
 if (FolderName != ) {
 Attributes.Push({Format: æ–‡ä»¶åç§°, Value: FolderName})
 Attributes.Push({Format: å…³é”®å­—, Value: FolderName})
 }
 
 Loop, Files, %FolderFullPath%\*.*, F
 {
 SplitPath, A_LoopFileName, , , , FileNameNoExt
 if (FileNameNoExt !=  && FileNameNoExt != A_LoopFileName) {
 Attributes.Push({Format: å…³é”®å­—, Value: FileNameNoExt})
 }
 }
 }
 } else {
 ; æ–‡ä»¶æ¨¡å¼
 if (AllPaths.MaxIndex() > 0) {
 Loop, % AllPaths.MaxIndex() {
 CurrentPath := AllPaths[A_Index]
 SplitPath, CurrentPath, FileName, , , FileNameNoExt
 
 if (FileName != ) {
 Attributes.Push({Format: æ–‡ä»¶åç§°, Value: FileName})
 }
 if (FileNameNoExt != ) {
 Attributes.Push({Format: å…³é”®å­—, Value: FileNameNoExt})
 }
 }
 }
 }
 } else {
 ; é CF_HDROP ä½†å¯èƒ½æ˜¯è·¯å¾„æ–‡æœ¬
 ExtractedFileName := 
 ExtractedNameNoExt := 
 if (Remark != ) {
 FirstPath := Remark
 if (InStr(Remark, `n)) {
 tmp := StrSplit(Remark, `n)
 FirstPath := Trim(tmp[1])
 }
 
 if (InStr(FirstPath, ") || InStr(FirstPath, /)) {
                SplitPath, FirstPath, TmpFileName, , , TmpFileNameNoExt
                ExtractedFileName := TmpFileName
                ExtractedNameNoExt := TmpFileNameNoExt
            } else {
                ExtractedFileName := FirstPath
            }
        }
        if (ExtractedFileName != ") {
 Attributes.Push({Format: æ–‡ä»¶åç§°, Value: ExtractedFileName})
 if (ExtractedNameNoExt != ) {
 Attributes.Push({Format: å…³é”®å­—, Value: ExtractedNameNoExt})
 } else {
 Attributes.Push({Format: å…³é”®å­—, Value: ExtractedFileName})
 }
 }
 }
 
 ; æ·»åŠ ç±»å‹å’Œæ ‡è¯†ç¬¦å±æ€§
 if (Format != ) {
 FormatParts := StrSplit(Format, ,)
 Loop, % FormatParts.Length() {
 TypeValue := Trim(FormatParts[A_Index])
 if (TypeValue !=  && TypeValue != CF_HDROP && TypeValue != CF_UNICODETEXT) {
 Attributes.Push({Format: ç±»å‹, Value: TypeValue})
 }
 }
 }
 
 if (Identifier != ) {
 IdentifierParts := StrSplit(Identifier, ,)
 Loop, % IdentifierParts.Length() {
 IDValue := Trim(IdentifierParts[A_Index])
 if (IDValue != ) {
 Attributes.Push({Format: æ ‡è¯†, Value: IDValue})
 }
 }
 }
 
 ; å¦‚æœæ˜¯ç½‘å€ï¼Œæ·»åŠ ç‰¹å®šå…³é”®å­—
 if (Identifier = ğŸ”—) {
 Attributes.Push({Format: å…³é”®å­—, Value: ç½‘å€})
 Attributes.Push({Format: å…³é”®å­—, Value: é“¾æ¥})
 Attributes.Push({Format: å…³é”®å­—, Value: ç½‘ç«™})
 }
 
 ; æ£€æµ‹ä»£ç 
 if (ClipData != ) {
 if (InStr(ClipData, ;) || InStr(ClipData, {) || InStr(ClipData, function) || InStr(ClipData, class )) {
 Attributes.Push({Format: å…³é”®å­—, Value: ä»£ç })
 }
 }
 
 ; æ·»åŠ åˆ†ç»„å±æ€§
 if (Group != ) {
 Attributes.Push({Format: åˆ†ç»„, Value: Group})
 }
 
 ; æ·»åŠ åº”ç”¨åç§°å±æ€§
 if (AppName !=  && AppName != æœªçŸ¥åº”ç”¨) {
 if !(RegExMatch(AppName, ^(v|V)?\d+(\.\d+)*$) || StrLen(AppName) <= 3) {
 Attributes.Push({Format: åº”ç”¨åç§°, Value: AppName})
 }
 }
 
 ; æ’å…¥æ‰€æœ‰å±æ€§
 for index, attr in Attributes {
 Result := InsertAttribute(MainTable, FinalID, attr.Format, attr.Value)
 ErrorMsg := Result.ErrorMsg
 if (!Result.Success && ErrorMsg != æ˜Ÿçº§ä¸º 0ï¼Œè·³è¿‡æ’å…¥ && ErrorMsg != å±æ€§æ ¼å¼æˆ–å€¼ä¸ºç©ºï¼Œè·³è¿‡) {
 RollbackSafeTransaction(ClipboardChanged)
 MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š2125567 æ’å…¥å±æ€§å¤±è´¥: %ErrorMsg%
 LoadData()
 Return
 }
 }
}

; ============================================================================
; ç¬¬6éƒ¨åˆ†ï¼šè¾…åŠ©å‡½æ•°
; ============================================================================

ValidateAndRestoreTables(MainTable, DataTable) {
 Global SQLiteDB
 
 OldMainTable := MainTable . _temp_old
 OldDataTable := DataTable . _temp_old
 PropTable := MainTable . _å…³è”å±æ€§
 OldPropTable := PropTable . _temp_old
 
 SQLiteDB.Exec(PRAGMA foreign_keys = OFF;)
 
 ; éªŒè¯å’Œæ¢å¤ä¸»è¡¨
 CheckMainSQL := SELECT name FROM sqlite_master WHERE type='table' AND name=' . MainTable . ';
 MainResult := {}
 if (SQLiteDB.GetTable(CheckMainSQL, MainResult) && MainResult.RowCount = 0) {
 CheckOldMainSQL := SELECT name FROM sqlite_master WHERE type='table' AND name=' . OldMainTable . ';
 OldMainResult := {}
 if (SQLiteDB.GetTable(CheckOldMainSQL, OldMainResult) && OldMainResult.RowCount > 0) {
 RenameMainSQL := ALTER TABLE [ . OldMainTable . ] RENAME TO [ . MainTable . ];
 if (!SQLiteDB.Exec(RenameMainSQL)) {
 ErrorMsg := SQLiteDB._ErrMsg()
 MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4111311 æ— æ³•æ¢å¤ä¸»è¡¨: %ErrorMsg%
 SQLiteDB.Exec(PRAGMA foreign_keys = ON;)
 Return false
 }
 } else {
 MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4113412 ä¸»è¡¨ç¼ºå¤±ä¸”æ— å¤‡ä»½ï¼
 SQLiteDB.Exec(PRAGMA foreign_keys = ON;)
 Return false
 }
 }
 
 SQLiteDB.Exec(PRAGMA foreign_keys = ON;)
 Return true
}

ValidateTableFields(MainTable) {
 Global SQLiteDB
 
 GetColumnsSQL := PRAGMA table_info( . MainTable . );
 ColumnsResult := {}
 RequiredFields := [å¤‡æ³¨, å†…å®¹, ç½®é¡¶, ç½®é¡¶ç´¢å¼•, æ”¶è—, ç¦åˆ , æ˜Ÿçº§, æ ‡ç­¾, åˆ†ç»„, ç±»å‹, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, è®¿é—®æ¬¡æ•°, æ›´æ–°æ¬¡æ•°, å­—èŠ‚, å­—ç¬¦, è¡Œæ•°, æ•°é‡, æ ‡è¯†, çª—å£è¯¦æƒ…, åº”ç”¨åç§°, å“ˆå¸Œå€¼, æ’åº, æ ‡è®°çŠ¶æ€]
 MissingFields := []
 
 if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
 ExistingColumns := []
 Loop, % ColumnsResult.RowCount {
 ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
 }
 for index, field in RequiredFields {
 if (!ArrayContains(ExistingColumns, field)) {
 MissingFields.Insert(field)
 }
 }
 if (MissingFields.MaxIndex() > 0) {
 MissingFieldsList := Join(MissingFields, , )
 MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4146625 %MainTable% è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%
 Return false
 }
 } else {
 ErrorMsg := SQLiteDB._ErrMsg()
 MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4149159 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
 Return false
 }
 
 Return true
}

UpdateLastInsertID(FinalID) {
 Global SQLiteDB
 
 DeleteRecordSQL := DELETE FROM "åˆ†ç±»å­—å…¸_One WHERE Category_Main = 'æœ€åæ’å…¥ID' AND Category_Sub = 'æœ€åæ’å…¥ID';
    SQLiteDB.Exec(DeleteRecordSQL)
    
    LastIDValue := (FinalID ? FinalID : ")
 InsertRecordSQL := INSERT OR REPLACE INTO "åˆ†ç±»å­—å…¸_One 
                     . (Category_Main, Category_Sub, Record_Value, Flag_Status, Update_Time) 
                     . VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', ?, 1, datetime('now','localtime'));
    
    if (SQLiteDB.ExecuteWithParams) {
        SQLiteDB.ExecuteWithParams(InsertRecordSQL, [LastIDValue])
    } else {
        EscapedLastID := StrReplace(LastIDValue, ', '')
        FallbackSQL := INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One 
                     . (Category_Main, Category_Sub, Record_Value, Flag_Status, Update_Time) 
                     . VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', ' . EscapedLastID . ', 1, datetime('now','localtime'));
        SQLiteDB.Exec(FallbackSQL)
    }
}
